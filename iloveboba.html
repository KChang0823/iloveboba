<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>我超愛喝手搖 - v6.0 Flexbox Fix</title>

  <script src="https://cdn.tailwindcss.com"></script>



  <style>
    /* Global Polish */
    body {
      background-color: #FFFBF0;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      -webkit-tap-highlight-color: transparent;
    }

    /* Scrollbar Polish */
    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }

    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    /* Animations */
    @keyframes float {

      0%,
      100% {
        transform: translateY(0px) rotate(var(--r));
      }

      50% {
        transform: translateY(-5px) rotate(var(--r));
      }
    }

    .sticker-hover {
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .sticker-hover:hover {
      transform: translateY(-8px) scale(1.05) rotate(0deg) !important;
      z-index: 30;
      box-shadow: 0 20px 30px -10px rgba(90, 62, 43, 0.3) !important;
    }

    @keyframes fall {
      0% {
        transform: translateY(-10vh) rotate(0deg) translateX(0);
        opacity: 1;
      }

      100% {
        transform: translateY(100vh) rotate(720deg) translateX(var(--fall-x));
        opacity: 0;
      }
    }

    .animate-fall {
      animation-name: fall;
      animation-timing-function: linear;
      animation-fill-mode: both;
    }

    /* Polaroid Texture Overlay for "Undeveloped" look */
    .polaroid-texture {
      background-image: radial-gradient(circle at 50% 0%, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0) 70%);
    }

    /* --- NEW: Fonts & Animations for Memory Feature --- */
    @import url('https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

    .font-handwriting {
      font-family: 'Patrick Hand', cursive;
    }

    @keyframes shake {

      0%,
      100% {
        transform: rotate(-1deg);
      }

      25% {
        transform: rotate(1deg);
      }

      50% {
        transform: rotate(-1.5deg);
      }

      75% {
        transform: rotate(1.5deg);
      }
    }

    .animate-shake {
      animation: shake 0.5s ease-in-out infinite;
    }

    @keyframes stamp-in {
      0% {
        transform: scale(3) rotate(-15deg);
        opacity: 0;
      }

      50% {
        transform: scale(0.9) rotate(-2deg);
        opacity: 1;
      }

      70% {
        transform: scale(1.05) rotate(-2deg);
      }

      100% {
        transform: scale(1) rotate(-2deg);
        opacity: 0.9;
      }
    }

    .animate-stamp-in {
      animation: stamp-in 0.4s cubic-bezier(0.22, 1, 0.36, 1) forwards;
    }

    /* --- 3D Flip Utilities --- */
    /* --- 3D Flip Utilities --- */
    .perspective-1000 {
      perspective: 1000px;
      -webkit-perspective: 1000px;
    }

    .transform-style-3d {
      transform-style: preserve-3d;
      -webkit-transform-style: preserve-3d;
    }

    .backface-hidden {
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
    }

    .rotate-y-180 {
      transform: rotateY(180deg);
      -webkit-transform: rotateY(180deg);
    }

    /* --- Receiptify Style Utilities --- */
    .font-receipt {
      font-family: 'VT323', monospace;
      text-shadow: 0 0 1px rgba(0, 0, 0, 0.1);
    }

    .receipt-mask {
      mask-image:
        radial-gradient(circle at 10px 0, transparent 10px, black 10.5px),
        radial-gradient(circle at 10px 100%, transparent 10px, black 10.5px);
      mask-size: 20px 100%;
      mask-position: top center;
      mask-repeat: repeat-x;
      mask-composite: intersect;
      -webkit-mask-image:
        radial-gradient(circle at 10px 0, transparent 10px, black 10.5px),
        radial-gradient(circle at 10px 100%, transparent 10px, black 10.5px);
      -webkit-mask-size: 20px 100%;
      -webkit-mask-composite: source-in;
    }

    .bg-noise {
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.08'/%3E%3C/svg%3E");
    }

    .css-barcode {
      background: repeating-linear-gradient(90deg,
          #2d2d2d 0px, #2d2d2d 2px, transparent 2px, transparent 4px,
          #2d2d2d 4px, #2d2d2d 5px, transparent 5px, transparent 7px,
          #2d2d2d 7px, #2d2d2d 10px, transparent 10px, transparent 13px);
    }
  </style>
</head>

<body>
  <div id="root"></div>



  <!-- Libraries -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/react-webcam@7.2.0/dist/react-webcam.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;

    // --- 設定區 ---
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzEgVZyXdJ9-DWbQao7OyxWG-QTuE2Z1ziMwe9orGLfBA2gjsQpUeU3DdCQx4J47C-k0Q/exec";

    // --- 圖示元件 ---
    const Icons = {
      ChevronLeft: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
        fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
        className={props.className}>
        <path d="m15 18-6-6 6-6" />
      </svg>,
      ChevronRight: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
        fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
        className={props.className}>
        <path d="m9 18 6-6-6-6" />
      </svg>,
      Coffee: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
        fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
        className={props.className}>
        <path d="M17 8h1a4 4 0 1 1 0 8h-1" />
        <path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z" />
        <line x1="6" x2="6" y1="2" y2="4" />
        <line x1="10" x2="10" y1="2" y2="4" />
        <line x1="14" x2="14" y1="2" y2="4" />
      </svg>,
      Image: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
        fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
        className={props.className}>
        <rect width="18" height="18" x="3" y="3" rx="2" ry="2" />
        <circle cx="9" cy="9" r="2" />
        <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21" />
      </svg>,
      X: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
        fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
        className={props.className}>
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>,
      Plus: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
        fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
        className={props.className}>
        <path d="M5 12h14" />
        <path d="M12 5v14" />
      </svg>,
      DollarSign: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
        fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
        className={props.className}>
        <line x1="12" x2="12" y1="2" y2="22" />
        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
      </svg>,
      Calendar: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
        fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
        className={props.className}>
        <path d="M8 2v4" />
        <path d="M16 2v4" />
        <rect width="18" height="18" x="3" y="4" rx="2" />
        <path d="M3 10h18" />
      </svg>,
      User: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
        fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
        className={props.className}>
        <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" />
        <circle cx="12" cy="7" r="4" />
      </svg>,
      Trophy: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
        fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
        className={props.className}>
        <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6" />
        <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18" />
        <path d="M4 22h16" />
        <path d="M10 14.66V17" />
        <path d="M14 14.66V17" />
        <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z" />
        <path d="M8.5 22v-2.87a6 6 0 0 1 2.5-5.13" />
        <path d="M15.5 22v-2.87a6 6 0 0 0-2.5-5.13" />
      </svg>,
      BarChart3: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
        fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
        className={props.className}>
        <path d="M3 3v18h18" />
        <path d="M18 17V9" />
        <path d="M13 17V5" />
        <path d="M8 17v-3" />
      </svg>,
      TrendingUp: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
        fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
        className={props.className}>
        <polyline points="22 7 13.5 15.5 8.5 10.5 2 17" />
        <polyline points="16 7 22 7 22 13" />
      </svg>,
      Store: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
        fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
        className={props.className}>
        <path d="m2 7 4.41-4.41A2 2 0 0 1 7.83 2h8.34a2 2 0 0 1 1.42.59L22 7" />
        <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8" />
        <path d="M15 22v-4a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v4" />
        <path d="M2 7h20" />
        <path
          d="M22 7v3a2 2 0 0 1-2 2v0a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 16 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 12 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 8 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 4 12v0a2 2 0 0 1-2-2V7" />
      </svg>,
      ChevronDown: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
        fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
        className={props.className}>
        <path d="m6 9 6 6 6-6" />
      </svg>,
      Dices: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
        fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
        className={props.className}>
        <rect width="12" height="12" x="2" y="10" rx="2" ry="2" />
        <path d="m17.92 14 3.5-3.5a2.24 2.24 0 0 0 0-3l-5-4.92a2.24 2.24 0 0 0-3 0L10 6" />
        <path d="M6 18h.01" />
        <path d="M10 14h.01" />
        <path d="M15 6h.01" />
        <path d="M18 9h.01" />
      </svg>,
      Medal: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
        fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
        className={props.className}>
        <path
          d="M7.21 15 2.66 7.14a2 2 0 0 1 .13-2.2L4.4 2.8A2 2 0 0 1 6 2h12a2 2 0 0 1 1.6.8l1.6 2.14a2 2 0 0 1 .14 2.2L16.79 15" />
        <path d="M11 12 5.12 2.2" />
        <path d="m13 12 5.88-9.8" />
        <circle cx="12" cy="19" r="4" />
        <path d="M12 17v4" />
        <path d="M12 14h0" />
      </svg>,
      Sparkles: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
        fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
        className={props.className}>
        <path
          d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L12 3Z" />
        <path d="M5 3v4" />
        <path d="M9 5H5" />
        <path d="M5 9v4" />
        <path d="M9 13H5" />
      </svg>,
      PartyPopper: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
        fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
        className={props.className}>
        <path d="M5.8 11.3 2 22l10.7-3.79" />
        <path d="M4 3h.01" />
        <path d="M22 8h.01" />
        <path d="M15 2h.01" />
        <path d="M22 20h.01" />
        <path
          d="m22 2-2.24.75a2.9 2.9 0 0 0-1.96 3V6a2 2 0 0 0-1.61 1.12l-.53 1.06a2 2 0 0 0-.2.91v.12a2 2 0 0 0 .56 1.51l.99.99a2 2 0 0 0 1.51.56h.12a2 2 0 0 0 .91-.2l1.06-.53a2 2 0 0 0 1.12-1.61V9a2.9 2.9 0 0 0 3-1.96L22 2Z" />
        <path d="m5.1 7.3.9.9" />
        <path d="m6.9 15.1.9.9" />
        <path d="m5.6 13.6.4.4" />
        <path d="m7.3 12 .9.9" />
      </svg>,
      RefreshCw: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
        fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
        className={props.className}>
        <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" />
        <path d="M21 3v5h-5" />
        <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" />
        <path d="M8 16H3v5" />
      </svg>,
      Gem: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
        fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
        className={props.className}>
        <path d="M6 3h12l4 6-10 13L2 9Z" />
        <path d="M11 3 8 9l4 13 4-13-3-6" />
        <path d="M2 9h20" />
      </svg>,
      HeartHandshake: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24"
        viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
        className={props.className}>
        <path
          d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" />
        <path
          d="M12 5 9.04 7.96a2.17 2.17 0 0 0 0 3.08v0c.82.82 2.13.85 3 .07l2.07-1.9a2.82 2.82 0 0 1 3.15-.49v0c.7.31 1.13 1.07 1.02 1.83v0a1.96 1.96 0 0 1-1.96 1.96c-.84 0-1.57.55-1.78 1.36v0c-.27 1.04 1.02 1.73 1.02 1.73" />
      </svg>,
      Ghost: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
        fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
        className={props.className}>
        <path d="M9 10h.01" />
        <path d="M15 10h.01" />
        <path d="M12 2a8 8 0 0 0-8 8v12l3-3 2.5 2.5L12 19l2.5 2.5L17 19l3 3V10a8 8 0 0 0-8-8z" />
      </svg>,
      ArrowLeft: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
        fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
        className={props.className}>
        <path d="m12 19-7-7 7-7" />
        <path d="M19 12H5" />
      </svg>,
      Download: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
        fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
        className={props.className}>
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
        <polyline points="7 10 12 15 17 10" />
        <line x1="12" x2="12" y1="15" y2="3" />
      </svg>,
      PieChart: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
        fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
        className={props.className}>
        <path d="M21.21 15.89A10 10 0 1 1 8 2.83" />
        <path d="M22 12A10 10 0 0 0 12 2v10z" />
      </svg>,
      Wifi: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
        fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
        className={props.className}>
        <path d="M5 12.55a11 11 0 0 1 14.08 0" />
        <path d="M1.42 9a16 16 0 0 1 21.16 0" />
        <path d="M8.53 16.11a6 6 0 0 1 6.95 0" />
        <line x1="12" x2="12.01" y1="20" y2="20" />
      </svg>,
      Trash2: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
        fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
        className={`${props.className} pointer-events-none`}>
        <path d="M3 6h18" />
        <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" />
        <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" />
        <line x1="10" x2="10" y1="11" y2="17" />
        <line x1="14" x2="14" y1="11" y2="17" />
      </svg>,
      Clock: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
        fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
        className={props.className}>
        <circle cx="12" cy="12" r="10" />
        <polyline points="12 6 12 12 16 14" />
      </svg>,
      Pencil: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
        fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
        className={`${props.className} pointer-events-none`}>
        <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z" />
        <path d="m15 5 4 4" />
      </svg>,
      Ban: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
        fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
        className={props.className}>
        <circle cx="12" cy="12" r="10" />
        <path d="m4.9 4.9 14.2 14.2" />
      </svg>,
      Save: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
        fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
        className={props.className}>
        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
        <polyline points="17 21 17 13 7 13 7 21" />
        <polyline points="7 3 7 8 15 8" />
      </svg>,
      Lock: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
        fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
        className={props.className}>
        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
      </svg>,
      Camera: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
        fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
        className={props.className}>
        <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z" />
        <circle cx="12" cy="13" r="3" />
      </svg>,
      CheckCircle: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
        fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
        className={props.className}>
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
        <polyline points="22 4 12 14.01 9 11.01"></polyline>
      </svg>
    };

    const BobaIcon = ({ size = 24, className = "" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"
        strokeLinecap="round" strokeLinejoin="round" className={`${className} hover:animate-bounce`}>
        <path d="M17 8h1a4 4 0 0 1 0 0h-1" opacity="0" />
        <path d="M6 8v11a2.5 2.5 0 0 0 2.5 2.5h7a2.5 2.5 0 0 0 2.5-2.5V8" />
        <line x1="4" y1="8" x2="20" y2="8" strokeLinecap="round" />
        <path d="M9 8L15 2" />
        <circle cx="10" cy="14" r="1.5" fill="currentColor" stroke="none" />
        <circle cx="14" cy="14" r="1.5" fill="currentColor" stroke="none" />
        <circle cx="8" cy="17" r="1.5" fill="currentColor" stroke="none" />
        <circle cx="12" cy="17" r="1.5" fill="currentColor" stroke="none" />
        <circle cx="16" cy="17" r="1.5" fill="currentColor" stroke="none" />
      </svg>
    );

    // --- REFINED: CustomDateTimePicker Components ---

    const CustomSelect = ({ value, options, onChange, suffix, className, transparent = false }) => (
      <div className={`relative ${className}`}>
        <select value={value} onChange={(e) => onChange(Number(e.target.value))}
          className={`appearance-none font-bold outline-none cursor-pointer transition-colors w-full ${transparent
            ? 'bg-transparent border-none h-full text-[#5A3E2B] px-0 text-center'
            : 'bg-[#FFF8E1] hover:bg-[#FFECB3] text-[#5A3E2B] h-10 md:h-12 border border-[#FFE0B2] rounded-xl focus:ring-2 focus:ring-[#FFCB7D] focus:border-[#FFCB7D] pl-2 pr-6 md:pr-8 text-center'
            } text-base md:text-sm`}
        >
          {options.map(opt => <option key={opt} value={opt}>{String(opt).padStart(2, '0')}{suffix}</option>)}
        </select>
        {!transparent && (
          <div className="absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none text-[#C4A484]">
            <Icons.ChevronDown className="w-4 h-4" />
          </div>
        )}
      </div>
    );

    const CustomDateTimePicker = ({ value, onChange }) => {
      const dateObj = value ? new Date(value) : new Date();
      const d = isNaN(dateObj.getTime()) ? new Date() : dateObj;

      const years = [2025, 2026, 2027];
      const months = Array.from({ length: 12 }, (_, i) => i + 1);
      const days = Array.from({ length: 31 }, (_, i) => i + 1);
      const hours = Array.from({ length: 24 }, (_, i) => i);
      const minutes = Array.from({ length: 60 }, (_, i) => i);

      const handleChange = (type, val) => {
        const newDate = new Date(d);
        if (type === 'year') newDate.setFullYear(val);
        if (type === 'month') newDate.setMonth(val - 1);
        if (type === 'day') newDate.setDate(val);
        if (type === 'hour') newDate.setHours(val);
        if (type === 'minute') newDate.setMinutes(val);

        const year = newDate.getFullYear();
        const month = String(newDate.getMonth() + 1).padStart(2, '0');
        const day = String(newDate.getDate()).padStart(2, '0');
        const hour = String(newDate.getHours()).padStart(2, '0');
        const minute = String(newDate.getMinutes()).padStart(2, '0');

        onChange(`${year}-${month}-${day}T${hour}:${minute}`);
      };

      const setNow = () => {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hour = String(now.getHours()).padStart(2, '0');
        const minute = String(now.getMinutes()).padStart(2, '0');
        onChange(`${year}-${month}-${day}T${hour}:${minute}`);
      };

      return (
        <div className="flex flex-col gap-2">
          {/* Date Row */}
          <div className="flex items-center gap-2">
            <div className="flex-1 flex gap-2 items-center">
              <CustomSelect value={d.getFullYear()} options={years} onChange={(v) => handleChange('year', v)} suffix="年"
                className="flex-[1.4]" />
              <CustomSelect value={d.getMonth() + 1} options={months} onChange={(v) => handleChange('month', v)} suffix="月"
                className="flex-1" />
              <CustomSelect value={d.getDate()} options={days} onChange={(v) => handleChange('day', v)} suffix="日"
                className="flex-1" />
            </div>
          </div>

          {/* Time & Now Button Row */}
          {/* FIXED: Flex layout for Time & Now Button */}
          <div className="flex w-full items-center justify-between gap-3">

            {/* Time Input Group */}
            <div
              className="flex-1 min-w-0 flex items-center justify-center bg-[#FFF8E1] border border-[#FFE0B2] rounded-xl h-12 px-2 relative">
              <span className="text-[#A1887F] text-xs font-bold absolute left-3">時間</span>
              <div className="flex items-center gap-1 pl-8 w-full justify-center">
                <CustomSelect value={d.getHours()} options={hours} onChange={(v) => handleChange('hour', v)} suffix=""
                  transparent={true} className="w-16" />
                <span className="font-bold text-[#5A3E2B]">:</span>
                <CustomSelect value={d.getMinutes()} options={minutes} onChange={(v) => handleChange('minute', v)} suffix=""
                  transparent={true} className="w-16" />
              </div>
            </div>

            {/* Now Button */}
            <button onClick={setNow}
              className="shrink-0 h-12 bg-[#FFCCBC] hover:bg-[#FFAB91] text-[#D84315] px-4 rounded-xl text-sm font-bold shadow-sm flex items-center gap-1.5 transition-colors whitespace-nowrap active:scale-95">
              <Icons.Clock className="w-4 h-4" /> 現在
            </button>
          </div>
        </div>
      );
    };

    // --- 資料與邏輯 ---
    const ICE_LEVELS = ['正常', '少冰', '微冰', '去冰', '常溫', '溫'];
    const SUGAR_LEVELS = ['全糖', '少糖', '半糖', '微糖', '一分糖', '無糖'];
    const USERS = [
      {
        name: 'Kevin', color: 'bg-[#AEE1FA]', barColor: 'bg-[#70C4EE]', lightColor: 'bg-[#E0F4FF]', textColor:
          'text-[#4A90B2]', borderColor: 'border-[#AEE1FA]'
      },
      {
        name: 'Ronnie', color: 'bg-[#FFC4D6]', barColor: 'bg-[#FF99B6]', lightColor: 'bg-[#FFF0F5]', textColor:
          'text-[#D97395]', borderColor: 'border-[#FFC4D6]'
      }
    ];

    const DEFAULT_SHOPS = [
      '50嵐', '可不可熟成紅茶', '得正', '一沐日', '迷客夏', '麻古茶坊', '龜記茗品',
      '五桐號', '清心福全', '萬波島嶼紅茶', '珍煮丹', '春水堂', '天仁茗茶',
      'CoCo都可', '大苑子', '茶湯會', 'COMEBUY', '烏弄', '再睡5分鐘',
      'SOMA', '約翰紅茶公司', '鶴茶樓', '路易莎', '老賴茶棧', '八曜和茶',
      '先喝道', '上宇林', '一手私藏世界紅茶', '康青龍'
    ];

    // --- 成就系統邏輯 (Same) ---
    const ACHIEVEMENTS = [
      {
        id: 'rich', title: '土豪金', desc: '找出所有價格超過 100 元的飲料',
        riddle: '一張紅色鈔票無法滿足的渴望...當那杯飲品的價值突破三位數，金色的光芒將會降臨。',
        tapeColor: 'bg-yellow-400/30', color: '#FFD700', // 閃亮金
        icon:
          <Icons.DollarSign className="text-yellow-600" size={20} />, bg: 'bg-[#FFF9C4]',
        check: (userDrinks) => {
          const unlockedItems = userDrinks.filter(d => d.price > 100);
          return { items: unlockedItems, progress: unlockedItems.length, target: 1 };
        }
      },
      {
        id: 'loyal', title: '專情的人', desc: '連續 5 次喝同一店家同一品項',
        riddle: '世間萬物都在變，唯有你的口味恆久不變。連續五次，別讓任何新歡打斷這份舊愛。',
        tapeColor: 'bg-purple-400/30', color: '#FF69B4', // 熱情粉
        icon:
          <Icons.Gem className="text-purple-500" size={20} />, bg: 'bg-[#E1BEE7]',
        check: (userDrinks) => {
          if (userDrinks.length < 5) return { items: [], progress: 0, target: 1 }; const sorted = [...userDrinks].sort((a, b) =>
            a.timestamp - b.timestamp);
          const streaks = [];
          let currentStreak = [sorted[0]];

          for (let i = 1; i < sorted.length; i++) {
            const prev = sorted[i - 1]; const curr = sorted[i]; if
              (prev.shopName === curr.shopName && prev.itemName === curr.itemName) { currentStreak.push(curr); } else {
              if
                (currentStreak.length >= 5) {
                streaks.push({
                  id: `streak-${i}`,
                  shopName: currentStreak[0].shopName,
                  itemName: currentStreak[0].itemName,
                  count: currentStreak.length,
                  date: currentStreak[currentStreak.length - 1].date,
                  drinks: [...currentStreak]
                });
              }
              currentStreak = [curr];
            }
          }
          if (currentStreak.length >= 5) {
            streaks.push({
              id: `streak-last`,
              shopName: currentStreak[0].shopName,
              itemName: currentStreak[0].itemName,
              count: currentStreak.length,
              date: currentStreak[currentStreak.length - 1].date,
              drinks: [...currentStreak]
            });
          }

          return { items: streaks, progress: streaks.length, target: 1 };
        }
      },
      {
        id: 'explorer', title: '嘗百草', desc: '單月內喝了超過 10 家不同的店',
        riddle: '神農氏的靈魂附身於此。在短短三十個日升日落之間，你的足跡必須踏遍十塊不同的領地。',
        tapeColor: 'bg-green-400/30', color: '#4CAF50', // 自然綠
        icon:
          <Icons.Store className="text-emerald-600" size={20} />, bg: 'bg-[#C8E6C9]',
        check: (userDrinks) => {
          const monthMap = {};
          userDrinks.forEach(d => {
            const dStr = d.date || '';
            if (!dStr) return;
            const [y, m] = dStr.split('-');
            const monthKey = `${y}-${m}`;
            if (!monthMap[monthKey]) monthMap[monthKey] = new Set();
            monthMap[monthKey].add(d.shopName);
          });

          const unlockedMonths = [];
          Object.entries(monthMap).forEach(([month, shopSet]) => {
            if (shopSet.size >= 10) {
              unlockedMonths.push({
                id: `explorer-${month}`,
                date: month,
                count: shopSet.size,
                shopName: `解鎖 ${shopSet.size} 家店`,
                itemName: '成就達成！'
              });
            }
          });

          const maxShops = Object.values(monthMap).reduce((max, set) => Math.max(max, set.size), 0);

          return { items: unlockedMonths, progress: maxShops, target: 10 };
        }
      },
      {
        id: 'copycat', title: '心有靈犀', desc: '同一天雙方喝了一模一樣的飲料',
        riddle: '原本是兩個獨立的靈魂，卻在某一刻做出了完全鏡像的選擇。店名、品項、甜度、冰塊，缺一不可的共鳴。',
        tapeColor: 'bg-rose-400/30', color: '#F43F5E', // 靈魂藍 -> Rose
        icon:
          <Icons.HeartHandshake className="text-rose-500" size={20} />, bg: 'bg-[#FFF1F2]', // Rose Background
        check: (userDrinks, allRecords, currentUser) => {
          const matches = [];
          Object.entries(allRecords).forEach(([date, dayDrinks]) => {
            const myDrinks = dayDrinks.filter(d => (d.user || '').trim() === currentUser);
            const otherDrinks = dayDrinks.filter(d => (d.user || '').trim() !== currentUser);

            myDrinks.forEach(myD => {
              const matchedPartnerDrink = otherDrinks.find(otherD =>
                otherD.shopName === myD.shopName &&
                otherD.itemName === myD.itemName &&
                otherD.ice === myD.ice &&
                otherD.sugar === myD.sugar
              );

              if (matchedPartnerDrink) {
                matches.push({
                  ...myD,
                  id: `match-${myD.id}`,
                  extraNote: `與 ${matchedPartnerDrink.user} 喝一樣！`
                });
              }
            });
          });
          return { items: matches, progress: matches.length, target: 1 };
        }
      },
      {
        id: 'solo', title: '獨吞大師', desc: '累積 15 天只有自己喝，對方沒喝',
        riddle: '寂寞是美食家的特權，或者...只是你忘了揪？當只有你一人獨享的時光累積成塔，孤獨的王者將加冕。',
        tapeColor: 'bg-gray-400/30', color: '#9C27B0', // 神祕紫
        icon:
          <Icons.Ghost className="text-slate-600" size={20} />, bg: 'bg-[#CFD8DC]',
        check: (userDrinks, allRecords, currentUser) => {
          let soloCount = 0;
          const unlockedBatches = [];
          const sortedDates = Object.keys(allRecords).sort();

          sortedDates.forEach(date => {
            const dayDrinks = allRecords[date];
            const hasMe = dayDrinks.some(d => (d.user || '').trim() === currentUser);
            const hasOther = dayDrinks.some(d => (d.user || '').trim() !== currentUser);

            if (hasMe && !hasOther) {
              soloCount++;
              if (soloCount > 0 && soloCount % 15 === 0) {
                unlockedBatches.push({
                  id: `solo-${soloCount}`,
                  date: date,
                  shopName: `獨吞 ${soloCount} 天`,
                  itemName: '累積達成',
                  price: 0
                });
              }
            }
          });
          return { items: unlockedBatches, progress: soloCount % 15, target: 15 };
        }
      }
    ];

    const normalizeDate = (dateStr) => {
      if (!dateStr) return null;
      const str = String(dateStr);
      if (str.length >= 10 && str.indexOf('-') !== -1) {
        return str.substring(0, 10);
      }
      return null;
    };

    // --- Cloudinary Service ---
    const uploadMemoryPhoto = async (base64Image) => {
      const CLOUD_NAME = "dh1ehevs0";
      const UPLOAD_PRESET = "iloveboba";
      const ENDPOINT = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`;

      const formData = new FormData();
      formData.append("file", base64Image);
      formData.append("upload_preset", UPLOAD_PRESET);

      try {
        const res = await fetch(ENDPOINT, { method: "POST", body: formData });
        const data = await res.json();
        return data.secure_url;
      } catch (error) {
        console.error("Cloudinary Upload Error:", error);
        throw error;
      }
    };

    // --- NEW: Reusable Polaroid Component ---
    const PolaroidCard = ({ imageSrc, date, rotation = 'rotate-0', className = '', washiTapeColor = 'bg-yellow-400',
      isShaking = false, showStamp = false }) => {
      return (
        <div className={`relative bg-white p-3 pb-12 shadow-2xl rounded-sm transform transition-all duration-300
        ${rotation} hover:rotate-0 hover:scale-105 hover:z-50 ${isShaking ? 'animate-shake' : ''} ${className}`}>
          {/* Washi Tape */}
          <div className={`absolute -top-3 left-1/2 -translate-x-1/2 w-24 h-6 ${washiTapeColor} shadow-sm z-20`} style={{
            transform: 'translateX(-50%) rotate(-2deg)', clipPath: 'polygon(2% 0%, 98% 2%, 100% 100%, 0% 98%)',
            maskImage: 'repeating-linear-gradient(-45deg,transparent,transparent 2px,black 3px,black 6px)'
          }}></div>

          {/* Image Area */}
          <div className="w-full aspect-square bg-gray-100 overflow-hidden relative border border-black/5">
            <img src={imageSrc} className="w-full h-full object-cover" alt="Memory" />

            {/* Developing/Loading Overlay */}
            {isShaking && (
              <div
                className="absolute inset-0 bg-black/50 backdrop-blur-[1px] flex flex-col items-center justify-center text-white z-10">
                <div className="animate-bounce font-bold tracking-widest text-[#FFCB7D]">回憶收藏中...</div>
              </div>
            )}

            {/* Stamp Overlay */}
            {showStamp && (
              <div className="absolute inset-0 z-20 flex items-center justify-center pointer-events-none">
                <div
                  className="animate-stamp-in w-24 h-24 border-[4px] border-red-600/70 rounded-full flex flex-col items-center justify-center text-red-600/80 font-black transform -rotate-12 bg-red-100/10 backdrop-blur-[1px]">
                  <div className="text-xs tracking-widest border-b border-red-600/50 pb-0.5 mb-0.5">ILOVEBOBA</div>
                  <div className="text-2xl">SAVED</div>
                  <div className="text-[10px] mt-0.5">{new Date().toLocaleDateString()}</div>
                </div>
              </div>
            )}
          </div>

          {/* Handwriting Date */}
          <div className="absolute bottom-3 left-0 right-0 text-center">
            <p className="text-[#5A3E2B]/80 text-xl font-handwriting rotate-1">
              {date}
            </p>
          </div>
        </div>
      );
    };

    // --- NEW: Lightbox Component with 3D Flip ---
    const MemoryLightbox = ({ photo, onClose }) => {
      const [isFlipped, setIsFlipped] = useState(false);

      if (!photo) return null;

      const handleFlip = (e) => {
        e.stopPropagation();
        setIsFlipped(!isFlipped);
      };

      return (
        <div className="fixed inset-0 z-[999] bg-black/90 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in duration-200" onClick={onClose}>
          <button onClick={onClose} className="absolute top-4 right-4 text-white/50 hover:text-white transition-colors z-[1000]">
            <Icons.X size={32} />
          </button>

          {/* 3D Container */}
          <div className="group w-full max-w-md aspect-[3/4] perspective-1000 cursor-pointer" onClick={handleFlip}>
            <div className={`relative w-full h-full transition-all duration-700 transform-style-3d ${isFlipped ? 'rotate-y-180' : ''}`}>

              {/* FRONT: Photo */}
              <div className="absolute inset-0 backface-hidden bg-white p-4 pb-16 shadow-2xl rounded-sm flex flex-col items-center justify-center">
                {/* Tape */}
                <div className={`absolute -top-3 left-1/2 -translate-x-1/2 w-32 h-8 ${photo.tapeColor || 'bg-amber-200'} shadow-sm z-20`} style={{
                  transform: 'translateX(-50%) rotate(-2deg)',
                  clipPath: 'polygon(2% 0%, 98% 2%, 100% 100%, 0% 98%)',
                  maskImage: 'repeating-linear-gradient(-45deg,transparent,transparent 2px,black 3px,black 6px)'
                }}></div>

                <div className="w-full h-full bg-gray-100 overflow-hidden relative border border-black/5">
                  <img src={photo.photoUrl} className="w-full h-full object-cover" />
                </div>

                <div className="absolute bottom-6 text-gray-400 font-mono text-xs flex items-center gap-2">
                  ↻ Click to Flip
                </div>
              </div>

              {/* BACK: Receiptify Style */}
              <div className="absolute inset-0 backface-hidden rotate-y-180 flex flex-col items-center justify-center p-4">
                {/* Paper Container - slightly larger than content to show texture */}
                <div className="relative w-full h-full bg-[#f0f0f0] shadow-xl overflow-hidden receipt-mask flex flex-col">

                  {/* Noise Overlay */}
                  <div className="absolute inset-0 bg-noise opacity-60 pointer-events-none mix-blend-multiply z-0"></div>

                  {/* Content */}
                  <div className="relative z-10 p-6 flex-1 flex flex-col font-receipt text-[#2d2d2d] uppercase tracking-tighter leading-none">

                    {/* Header */}
                    <div className="text-center border-b-2 border-dashed border-[#2d2d2d]/30 pb-4 mb-4">
                      <div className="text-3xl font-bold tracking-widest mb-1">ILOVEBOBA</div>
                      <div className="text-sm">ALL TIME</div>
                    </div>

                    {/* Meta */}
                    <div className="flex justify-between text-sm mb-4">
                      <span>ORD #{photo.timestamp.toString().slice(-4)}</span>
                      <span>FOR {photo.user}</span>
                    </div>
                    <div className="text-sm mb-4 text-center">
                      {photo.date || new Date(photo.timestamp).toLocaleDateString()}
                    </div>

                    {/* Table Header */}
                    <div className="flex text-sm border-b-2 border-dashed border-[#2d2d2d]/30 pb-2 mb-2">
                      <span className="w-12">QTY</span>
                      <span className="flex-1">ITEM</span>
                      <span className="w-12 text-right">AMT</span>
                    </div>

                    <div className="flex-1 overflow-y-auto scrollbar-hide space-y-2">
                      <div className="flex text-sm">
                        <span className="w-12">01</span>
                        <span className="flex-1 text-lg font-bold">{photo.shopName}</span>
                        <span className="w-12 text-right">{photo.price}</span>
                      </div>
                      <div className="flex text-sm pl-12 opacity-70">
                        <span className="flex-1">&gt; 30% SUGAR</span>
                        <span className="w-12 text-right">0</span>
                      </div>
                      <div className="flex text-sm pl-12 opacity-70">
                        <span className="flex-1">&gt; NO ICE</span>
                        <span className="w-12 text-right">0</span>
                      </div>
                      <div className="flex text-sm mt-2">
                        <span className="w-12">04</span>
                        <span className="flex-1 text-lg font-bold">[{photo.title}]</span>
                        <span className="w-12 text-right">1</span>
                      </div>
                    </div>

                    {/* Footer */}
                    <div className="border-t-2 border-dashed border-[#2d2d2d]/30 pt-4 mt-4 space-y-1">
                      <div className="flex justify-between text-lg font-bold">
                        <span>TOTAL</span>
                        <span>${photo.price}</span>
                      </div>
                      <div className="text-xs pt-2 text-center">CARD #: **** **** **** 2026</div>
                      <div className="text-xs text-center">AUTH: 1314520</div>
                      <div className="text-center text-sm pt-2 font-bold">THANK YOU FOR VISITING!</div>
                    </div>

                    {/* Barcode */}
                    <div className="h-10 w-full css-barcode mt-4 opacity-80"></div>

                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>
      );
    };

    // --- Celebration & Camera Modal ---
    const CelebrationCameraModal = ({ achievement, user, onClose, onSaveMemory }) => {
      if (!achievement) return null;
      const [phase, setPhase] = useState('CELEBRATION'); // CELEBRATION, PREVIEW, SAVING, SUCCESS
      const [photoData, setPhotoData] = useState(null);
      const fileInputRef = useRef(null);

      // Confetti effect on mount
      useEffect(() => {
        if (phase === 'CELEBRATION' && typeof confetti === 'function') {
          const duration = 3000;
          const end = Date.now() + duration;
          const frame = () => {
            try {
              confetti({
                particleCount: 5, angle: 60, spread: 55, origin: { x: 0 }, colors: ['#FFCB7D', '#AEE1FA', '#FFC4D6']
              });
              confetti({
                particleCount: 5, angle: 120, spread: 55, origin: { x: 1 }, colors: ['#FFCB7D', '#AEE1FA', '#FFC4D6']
              });
            } catch (e) { console.warn(e); }
            if (Date.now() < end) requestAnimationFrame(frame);
          }; frame();
        }
      }, [phase]); const handleStartCamera = () => {
        if (fileInputRef.current) fileInputRef.current.click();
      };

      const handleFileChange = (event) => {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onloadend = () => {
            setPhotoData(reader.result);
            setPhase('PREVIEW');
          };
          reader.readAsDataURL(file);
        }
      };

      const handleSave = async () => {
        if (!photoData) return;
        setPhase('SAVING'); // Start "Shake"

        try {
          const photoUrl = await uploadMemoryPhoto(photoData);
          await onSaveMemory(photoUrl);

          setPhase('SUCCESS'); // Start "Stamp"

          // Wait for stamp animation then close
          setTimeout(() => {
            onClose();
          }, 2000);
        } catch (e) {
          console.error("Upload failed", e);
          alert("上傳失敗，請重試");
          setPhase('PREVIEW');
        }
      };

      const handleRetake = () => {
        setPhotoData(null);
        handleStartCamera();
      };

      return (
        <div className={`fixed inset-0 z-[100] flex items-center justify-center p-4 transition-all duration-300 ${phase
          !== 'CELEBRATION' ? 'bg-black/80 backdrop-blur-sm' : 'bg-[#5A3E2B]/80 backdrop-blur-md'}`}>
          {/* Hidden File Input */}
          <input type="file" accept="image/*" capture="environment" ref={fileInputRef} className="hidden"
            onChange={handleFileChange} />

          {phase === 'CELEBRATION' ? (
            /* Phase 1: Celebration Dialog */
            <div
              className="bg-[#FFFBF0] w-full max-w-sm rounded-[2.5rem] shadow-2xl relative border-[6px] border-white p-8 text-center flex flex-col items-center animate-in zoom-in duration-300">
              <div
                className="w-24 h-24 rounded-full bg-[#FFCB7D] flex items-center justify-center shadow-inner mb-6 animate-bounce">
                <Icons.Trophy size={48} className="text-[#5A3E2B]" />
              </div>
              <h2 className="text-3xl font-black text-[#5A3E2B] mb-2">成就解鎖！</h2>
              <p className="text-lg font-bold text-[#8D6E63] mb-8">{achievement.title}</p>
              <div className="space-y-3 w-full">
                <button onClick={handleStartCamera}
                  className="w-full py-4 bg-[#5A3E2B] text-[#FFCB7D] rounded-2xl font-black text-lg shadow-lg hover:scale-105 active:scale-95 transition-all flex items-center justify-center gap-2">
                  <Icons.Camera size={24} /> 拍照留念
                </button>
                <button onClick={onClose}
                  className="w-full py-3 text-[#A1887F] font-bold text-sm hover:bg-[#A1887F]/10 rounded-xl transition-colors">
                  以後再說
                </button>
              </div>
            </div>
          ) : (
            /* Phase 2: Polaroid Preview (Immersive) */
            <div className="flex flex-col items-center gap-8 max-w-sm w-full animate-in fade-in zoom-in duration-300">
              <PolaroidCard imageSrc={photoData} date={new Date().toLocaleDateString()} rotation="rotate-1"
                isShaking={phase === 'SAVING'} showStamp={phase === 'SUCCESS'} washiTapeColor={achievement.tapeColor} />

              {phase === 'PREVIEW' && (
                <div className="flex items-center gap-4 w-full px-4">
                  <button onClick={handleRetake}
                    className="flex-1 py-3 border-2 border-[#FFCB7D]/30 text-[#FFCB7D] rounded-full font-bold hover:bg-[#FFCB7D]/10 transition-colors">
                    重拍
                  </button>
                  <button onClick={handleSave}
                    className="flex-[2] py-3 bg-[#FFCB7D] text-[#5A3E2B] rounded-full font-black shadow-[0_0_20px_rgba(255,203,125,0.4)] hover:bg-[#FFDCA9] hover:scale-105 transition-all flex items-center justify-center gap-2">
                    <Icons.CheckCircle size={20} /> 儲存回憶
                  </button>
                </div>
              )}
            </div>
          )}
        </div>
      );
    };

    class ErrorBoundary extends React.Component {
      constructor(props) {
        super(props);
        this.state = { hasError: false, error: null };
      }

      static getDerivedStateFromError(error) {
        return { hasError: true, error };
      }

      componentDidCatch(error, errorInfo) {
        console.error("ErrorBoundary caught error:", error, errorInfo);
      }

      render() {
        if (this.state.hasError) {
          return (
            <div
              className="fixed inset-0 z-[200] bg-black/80 flex flex-col items-center justify-center p-8 text-center text-white backdrop-blur-sm">
              <h2 className="text-2xl font-bold mb-4 text-[#FFCB7D]">出錯了 Oops!</h2>
              <div
                className="bg-red-900/50 p-4 rounded-xl text-left overflow-auto max-w-full text-xs font-mono border border-red-500/30 mb-6">
                {this.state.error && this.state.error.toString()}
              </div>
              <button onClick={() => {
                this.setState({ hasError: false });
                if (this.props.onReset) this.props.onReset();
              }}
                className="px-8 py-3 bg-[#5A3E2B] text-[#FFCB7D] rounded-xl font-bold hover:scale-105 transition-transform"
              >
                關閉並繼續 Close
              </button>
            </div>
          );
        }
        return this.props.children;
      }
    }

    const BobaTracker = () => {
      const [currentView, setCurrentView] = useState('calendar');
      const [currentDate, setCurrentDate] = useState(new Date(2026, 0, 1));
      const [selectedDate, setSelectedDate] = useState(null);
      const [records, setRecords] = useState({});
      const [memoryPhotos, setMemoryPhotos] = useState([]);
      const [isModalOpen, setIsModalOpen] = useState(false);
      const [isRandomizerOpen, setIsRandomizerOpen] = useState(false);
      const [isLoading, setIsLoading] = useState(true);
      const [isSending, setIsSending] = useState(false);
      const [statusMsg, setStatusMsg] = useState('正在初始化連線...');
      const [selectedUser, setSelectedUser] = useState('Kevin');
      const [shopName, setShopName] = useState('');
      const [itemName, setItemName] = useState('');
      const [ice, setIce] = useState('');
      const [sugar, setSugar] = useState('');
      const [price, setPrice] = useState('');
      const [isShopDropdownOpen, setIsShopDropdownOpen] = useState(false);
      const [recordDateTime, setRecordDateTime] = useState('');

      const [selectedAchievement, setSelectedAchievement] = useState(null);
      const [unlockedQueue, setUnlockedQueue] = useState([]);
      const [editingId, setEditingId] = useState(null);
      const [lightBoxPhoto, setLightBoxPhoto] = useState(null);

      const fetchData = async () => {
        setIsLoading(true);
        setStatusMsg('正在讀取資料...');
        try {
          const response = await fetch(`${GOOGLE_SCRIPT_URL}?t=${new Date().getTime()}`);
          if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
          const rawResponse = await response.json();
          // Compatible with old array format or new object format
          const data = Array.isArray(rawResponse) ? rawResponse : (rawResponse.records || []);
          const memories = Array.isArray(rawResponse) ? [] : (rawResponse.achievements || []);

          setMemoryPhotos(memories);
          console.log('Data loaded:', data);

          const newRecords = {};
          if (Array.isArray(data)) {
            data.forEach((row, index) => {
              const rawTimestamp = row.timestamp;
              let dateStr = row.date;
              if (!dateStr && rawTimestamp) {
                const tsString = String(rawTimestamp);
                const validTs = Number(tsString.length > 13 ? tsString.slice(0, 13) : tsString);
                if (!isNaN(validTs)) {
                  dateStr = new Date(validTs).toISOString().substring(0, 10);
                }
              }
              const normalizedDate = normalizeDate(dateStr);
              if (!normalizedDate) return;
              const hasValidId = !!rawTimestamp;
              const drink = {
                id: `sheet-${index}`,
                user: row.who ? row.who.trim() : row.who,
                shopName: row.shop,
                itemName: row.item,
                ice: row.ice,
                sugar: row.sugar,
                price: Number(row.price),
                date: normalizedDate,
                timestamp: hasValidId ? rawTimestamp : Date.now(),
                isDeletable: hasValidId
              };
              if (!newRecords[normalizedDate]) newRecords[normalizedDate] = [];
              newRecords[normalizedDate].push(drink);
            });
          }
          setRecords(newRecords);
          setStatusMsg('同步完成！');
          setTimeout(() => setStatusMsg(''), 3000);
        } catch (error) {
          console.error("Fetch Error:", error);
          setStatusMsg(`讀取失敗: ${error.message}`);
        } finally {
          setIsLoading(false);
        }
      };

      useEffect(() => { fetchData(); }, []);

      const isDailyLimitReached = useMemo(() => {
        const targetDate = recordDateTime ? recordDateTime.split('T')[0] : selectedDate;
        if (!targetDate) return false;
        if (editingId) return false;
        const currentRecords = records[targetDate] || [];
        const userDailyCount = currentRecords.filter(r => (r.user || '').trim() === selectedUser).length;
        return userDailyCount >= 2;
      }, [selectedDate, recordDateTime, selectedUser, records, editingId]);

      const allDrinks = Object.values(records).flat();

      const exportToCSV = () => {
        const headers = ['日期', '誰喝的', '店名', '品項', '冰塊', '甜度', '價格'];
        const csvRows = [headers.join(',')];
        Object.entries(records).forEach(([date, dayDrinks]) => {
          dayDrinks.forEach(drink => {
            const row = [date, drink.user, `"${drink.shopName}"`, `"${drink.itemName}"`, drink.ice, drink.sugar,
              drink.price];
            csvRows.push(row.join(','));
          });
        });
        const csvString = "\uFEFF" + csvRows.join('\n');
        const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `boba_tracker_export_${new Date().toISOString().slice(0, 10)}.csv`;
        link.click();
        URL.revokeObjectURL(url);
      };

      const sortedShopOptions = useMemo(() => {
        const shopCounts = {};
        allDrinks.forEach(r => { if (r.shopName) shopCounts[r.shopName] = (shopCounts[r.shopName] || 0) + 1; });
        const allShopsSet = new Set([...Object.keys(shopCounts), ...DEFAULT_SHOPS]);
        return Array.from(allShopsSet).sort((a, b) => {
          const countA = shopCounts[a] || 0;
          const countB = shopCounts[b] || 0;
          if (countB !== countA) return countB - countA;
          return a.localeCompare(b, 'zh-TW');
        });
      }, [allDrinks]);

      const filteredShops = useMemo(() => {
        if (!shopName) return sortedShopOptions;
        return sortedShopOptions.filter(shop => shop.toLowerCase().includes(shopName.toLowerCase()));
      }, [shopName, sortedShopOptions]);

      const getStats = (userName, customRecords) => {
        const targetRecords = customRecords || records;
        const targetAllDrinks = Object.values(targetRecords).flat();
        const userDrinks = targetAllDrinks.filter(d => (d.user || '').trim() === userName);
        return {
          cups: userDrinks.length,
          cost: userDrinks.reduce((sum, item) => sum + (Number(item.price) || 0), 0),
          drinks: userDrinks,
          achievements: ACHIEVEMENTS.map(ach => {
            const result = ach.check(userDrinks, targetRecords, userName);
            return {
              ...ach,
              items: result.items,
              progress: result.progress,
              target: result.target
            };
          })
        };
      };

      const kevinStats = getStats('Kevin');
      const ronnieStats = getStats('Ronnie');

      const getMonthlyData = () => {
        const data = Array.from({ length: 12 }, (_, i) => ({ month: i + 1, Kevin: 0, Ronnie: 0 }));
        Object.entries(records).forEach(([dateStr, dayRecords]) => {
          if (!dateStr) return;
          const parts = dateStr.split('-');
          if (parts.length < 2) return; const monthIndex = parseInt(parts[1], 10) - 1; if (monthIndex >= 0 && monthIndex <
            12) {
            dayRecords.forEach(r => {
              const userKey = (r.user || '').trim();
              if (userKey === 'Kevin') data[monthIndex].Kevin++;
              else if (userKey === 'Ronnie') data[monthIndex].Ronnie++;
            });
          }
        });
        return data;
      };

      const getTopShops = (drinks) => {
        const counts = {};
        drinks.forEach(d => { counts[d.shopName] = (counts[d.shopName] || 0) + 1; });
        return Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 3);
      };

      const getPreferenceStats = (drinks, type) => {
        const counts = {};
        const total = drinks.length || 1;
        const levels = type === 'sugar' ? SUGAR_LEVELS : ICE_LEVELS;
        levels.forEach(l => counts[l] = 0);
        drinks.forEach(d => {
          const val = type === 'sugar' ? d.sugar : d.ice;
          if (counts[val] !== undefined) counts[val]++;
        });
        return levels.map(label => ({
          label, count: counts[label], percent: total === 0 ? 0 :
            Math.round((counts[label] / total) * 100)
        }));
      };

      const getMaxPriceDrink = (drinks) => {
        if (drinks.length === 0) return null;
        return drinks.reduce((max, curr) => (curr.price > max.price ? curr : max), drinks[0]);
      };

      const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
      const getFirstDayOfMonth = (year, month) => new Date(year, month, 1).getDay();
      const handlePrevMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1,
        1));
      const handleNextMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1,
        1));
      const formatDateKey = (date) => `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2,
        '0')}-${String(date.getDate()).padStart(2, '0')}`;

      const openDateModal = (day) => {
        const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
        const dateStr = formatDateKey(date);
        setSelectedDate(dateStr);
        const now = new Date();
        const timeStr = now.toTimeString().slice(0, 5);
        setRecordDateTime(`${dateStr}T${timeStr}`);
        setIsModalOpen(true);
        resetForm();
      };

      const resetForm = () => {
        setShopName(''); setItemName(''); setIce(''); setSugar(''); setPrice('');
        setIsShopDropdownOpen(false);
        setEditingId(null);
      };

      const handleDateTimeChange = (newVal) => {
        setRecordDateTime(newVal);
        if (newVal) {
          const datePart = newVal.split('T')[0];
          if (datePart !== selectedDate) { setSelectedDate(datePart); }
        }
      }

      const handleEdit = (drink) => {
        setEditingId(drink.timestamp);
        setSelectedUser((drink.user || '').trim());
        setShopName(drink.shopName);
        setItemName(drink.itemName);
        setIce(drink.ice);
        setSugar(drink.sugar);
        setPrice(drink.price);
        let fullDateTime = '';
        try {
          const datePart = drink.date;
          const tsString = String(drink.timestamp);
          const validTs = Number(tsString.length > 13 ? tsString.slice(0, 13) : tsString);
          const oldDate = new Date(validTs);
          const hours = String(oldDate.getHours()).padStart(2, '0');
          const minutes = String(oldDate.getMinutes()).padStart(2, '0');
          fullDateTime = `${datePart}T${hours}:${minutes}`;
        } catch (e) {
          console.error("Date construction error", e);
          fullDateTime = new Date().toISOString().slice(0, 16);
        }
        setRecordDateTime(fullDateTime);
        if (drink.date) {
          setSelectedDate(drink.date);
        }
      };

      const handleCancelEdit = () => {
        resetForm();
        const now = new Date();
        const timeStr = now.toTimeString().slice(0, 5);
        if (selectedDate) setRecordDateTime(`${selectedDate}T${timeStr}`);
      };

      const handleAddDrink = async () => {
        if (!editingId && isDailyLimitReached) return;
        if (!shopName || !itemName || !ice || !sugar || !price) { alert("請填寫所有欄位！"); return; }

        setIsSending(true);
        setStatusMsg('正在儲存資料...');

        const baseTime = new Date(recordDateTime).getTime();
        const randomPart = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
        const newTimestamp = baseTime.toString() + randomPart;

        const dateKey = recordDateTime.split('T')[0];

        const oldUserStats = getStats(selectedUser, records);
        let nextRecords = { ...records };

        if (editingId) {
          const payload = {
            action: 'update',
            timestamp: String(editingId),
            who: selectedUser,
            shop: shopName,
            item: itemName,
            ice, sugar, price,
            date: dateKey,
            newTimestamp: newTimestamp
          };
          let foundDateKey = null;
          for (const [dKey, dList] of Object.entries(nextRecords)) {
            if (dList.some(r => r.timestamp === editingId)) {
              foundDateKey = dKey;
              break;
            }
          }
          if (foundDateKey) {
            nextRecords[foundDateKey] = nextRecords[foundDateKey].filter(r => r.timestamp !== editingId);
            if (nextRecords[foundDateKey].length === 0) delete nextRecords[foundDateKey];
          }

          if (!nextRecords[dateKey]) nextRecords[dateKey] = [];
          nextRecords[dateKey].push({
            id: `sheet-edited-${Date.now()}`,
            user: selectedUser, shopName, itemName, ice, sugar,
            price: Number(price), date: dateKey,
            timestamp: newTimestamp,
            isDeletable: true
          });

          const sendUpdate = async () => {
            await fetch(GOOGLE_SCRIPT_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'text/plain' },
              body: JSON.stringify(payload)
            });
          };
          sendUpdate().then(() => { setStatusMsg('修改成功！'); setTimeout(() => setStatusMsg(''), 2000); }).catch(e =>
            setStatusMsg("傳送失敗"));

        } else {
          const payload = {
            who: selectedUser, shop: shopName, item: itemName, ice, sugar, price, date: dateKey,
            timestamp: newTimestamp
          };

          if (!nextRecords[dateKey]) nextRecords[dateKey] = [];
          nextRecords[dateKey].push({
            id: `temp-${newTimestamp}`,
            user: selectedUser, shopName, itemName, ice, sugar, price: Number(price), date: dateKey,
            timestamp: newTimestamp,
            isDeletable: true
          });

          const sendAdd = async () => {
            await fetch(GOOGLE_SCRIPT_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'text/plain' },
              body: JSON.stringify(payload)
            });
          };
          sendAdd().then(() => { setStatusMsg('儲存成功！'); setTimeout(() => setStatusMsg(''), 2000); }).catch(e =>
            setStatusMsg("傳送失敗"));
        }

        const newUserStats = getStats(selectedUser, nextRecords);
        const newlyUnlockedList = newUserStats.achievements.filter(newAch => {
          const oldAch = oldUserStats.achievements.find(a => a.id === newAch.id);
          return newAch.items.length > oldAch.items.length;
        });

        if (newlyUnlockedList.length > 0) {
          setUnlockedQueue(prev => [...prev, ...newlyUnlockedList]);
        }
        setRecords(nextRecords);
        resetForm();
        setIsSending(false);
      };

      const handleDeleteDrink = async (drink) => {
        if (!drink.isDeletable) {
          setStatusMsg("無法刪除 (無ID)，僅移除畫面");
          setTimeout(() => setStatusMsg(''), 3000);
          const targetDate = drink.date;
          const currentRecords = records[targetDate].filter(r => r.id !== drink.id);
          let newRecords;
          if (currentRecords.length === 0) { newRecords = { ...records }; delete newRecords[targetDate]; }
          else { newRecords = { ...records, [targetDate]: currentRecords }; }
          setRecords(newRecords);
          return;
        }

        setStatusMsg('正在刪除...');
        const targetDate = drink.date;
        const currentRecords = records[targetDate].filter(r => r.id !== drink.id);
        let newRecords;
        if (currentRecords.length === 0) { newRecords = { ...records }; delete newRecords[targetDate]; }
        else { newRecords = { ...records, [targetDate]: currentRecords }; }
        setRecords(newRecords);

        try {
          await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify({ action: 'delete', timestamp: String(drink.timestamp) })
          });
          setStatusMsg('刪除成功');
          setTimeout(() => setStatusMsg(''), 2000);
        } catch (e) {
          console.error("Error deleting:", e);
          setStatusMsg("刪除失敗");
        }
      };

      const renderCalendarDays = () => {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const daysInMonth = getDaysInMonth(year, month);
        const firstDay = getFirstDayOfMonth(year, month);
        const blanks = Array(firstDay).fill(null);
        const days = Array.from({ length: daysInMonth }, (_, i) => i + 1);
        return [...blanks, ...days].map((day, index) => {
          if (!day) return <div key={`blank-${index}`} className="min-h-[80px] bg-transparent"></div>;
          const dateKey = formatDateKey(new Date(year, month, day));
          const dayRecords = records[dateKey] || [];
          const kevinCount = dayRecords.filter(r => (r.user || '').trim() === 'Kevin').length;
          const ronnieCount = dayRecords.filter(r => (r.user || '').trim() === 'Ronnie').length;
          return (
            <div key={dateKey} onClick={() => openDateModal(day)} className="min-h-[80px] bg-white/60 hover:bg-white
              border-2 border-transparent hover:border-amber-200 rounded-3xl cursor-pointer transition-all duration-300
              p-2 flex flex-col relative group shadow-sm hover:shadow-md">
              <div className="flex justify-between items-start mb-1"><span className={`text-sm font-bold ml-1
                  ${dayRecords.length > 0 ? 'text-amber-600' : 'text-gray-400'}`}>{day}</span></div>
              <div className="flex flex-wrap gap-1 content-start md:flex-col md:gap-1 md:flex-nowrap">
                {dayRecords.map((record, idx) => {
                  const isKevin = (record.user || '').trim() === 'Kevin';
                  const initial = record.shopName ? record.shopName.charAt(0) : '?';
                  return (
                    <div key={idx} className={` font-bold shadow-sm border border-white transition-all w-5 h-5 flex
                  items-center justify-center rounded-full text-[10px] md:w-full md:h-auto md:py-1 md:px-2 md:rounded-lg
                  md:text-xs md:justify-start ${isKevin ? 'bg-[#E0F4FF] text-[#4A90B2]' : 'bg-[#FFF0F5] text-[#D97395]'
                      } `} title={record.shopName}>
                      <span className="md:hidden">{initial}</span>
                      <span className="hidden md:block truncate text-left">{record.shopName}</span>
                    </div>
                  );
                })}
              </div>
              <div className="absolute bottom-2 right-2 flex -space-x-1">
                {kevinCount >= 2 && <div className="w-3 h-3 rounded-full bg-[#AEE1FA] border-2 border-white"
                  title="Kevin Limit"></div>}
                {ronnieCount >= 2 && <div className="w-3 h-3 rounded-full bg-[#FFC4D6] border-2 border-white"
                  title="Ronnie Limit"></div>}
              </div>
            </div>
          );
        });
      };

      const RandomizerModal = () => {
        const [isSpinning, setIsSpinning] = useState(false);
        const [result, setResult] = useState(null);
        const [displayOption, setDisplayOption] = useState(null);
        const optionsPool = useMemo(() => {
          const historyOptions = allDrinks.map(d => ({ shop: d.shopName, item: d.itemName }));
          const defaultOptions = DEFAULT_SHOPS.map(s => ({ shop: s, item: '招牌/新品' }));
          const uniqueOptions = [];
          const seen = new Set();
          [...historyOptions, ...defaultOptions].forEach(opt => {
            const key = `${opt.shop}-${opt.item}`; if
              (!seen.has(key)) { seen.add(key); uniqueOptions.push(opt); }
          });
          return uniqueOptions;
        }, []);

        const handleSpin = () => {
          if (isSpinning) return;
          setIsSpinning(true); setResult(null);
          let duration = 0;
          const interval = setInterval(() => {
            const randomOpt = optionsPool[Math.floor(Math.random() * optionsPool.length)];
            setDisplayOption(randomOpt); duration += 100;
            if (duration > 2000) { clearInterval(interval); setResult(randomOpt); setIsSpinning(false); }
          }, 80);
        };

        return (
          <div className="fixed inset-0 bg-[#5A3E2B]/40 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
            <div
              className="bg-[#FFFBF0] rounded-[2.5rem] shadow-xl w-full max-w-sm p-8 text-center relative border-4 border-white">
              <button onClick={() => setIsRandomizerOpen(false)} className="absolute top-5 right-5 text-[#C4A484]
                  hover:text-[#8B5E3C] p-2 hover:bg-[#FFE0B2] rounded-full transition-colors">
                <Icons.X size={24} />
              </button>
              <div className="mb-4 flex justify-center">
                <div className="bg-[#FFEFD5] p-5 rounded-full">
                  <Icons.Dices size={40} className="text-[#F4A261]" />
                </div>
              </div>
              <h3 className="text-2xl font-black text-[#5A3E2B] mb-2 tracking-wide">今天喝什麼？</h3>
              <p className="text-[#8D6E63] text-sm mb-8 font-medium">命運的安排最美味 😋</p>
              <div
                className="h-32 flex items-center justify-center mb-8 bg-white rounded-3xl border-4 border-[#FFEFD5] shadow-inner relative">
                {displayOption ? (<div className="animate-in zoom-in duration-200">
                  <div className="text-xl font-bold text-[#8B5E3C] mb-1">{displayOption.shop}</div>
                  <div className="text-[#C4A484] font-medium">{displayOption.item}</div>
                </div>) : <span className="text-[#E0E0E0] text-4xl font-bold">?</span>}
                {result && <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                  <Icons.PartyPopper className="text-[#FFCB7D] w-full h-full opacity-30 animate-ping" />
                </div>}
              </div>
              <button onClick={handleSpin} disabled={isSpinning} className={`w-full py-4 rounded-2xl font-bold text-lg
                  shadow-md flex items-center justify-center gap-2 transition-all ${isSpinning
                  ? 'bg-gray-200 text-gray-400' : 'bg-[#FFCB7D] text-[#5A3E2B] hover:bg-[#FFDCA9] hover:-translate-y-1'
                }`}>{isSpinning ? <>
                  <Icons.RefreshCw className="animate-spin" /> 轉動中...
                </> : <>
                  <Icons.Sparkles /> 開始抽選
                </>}</button>
            </div>
          </div>
        );
      };

      const StatsView = () => {
        const monthlyData = getMonthlyData();
        const kevinMax = getMaxPriceDrink(kevinStats.drinks);
        const ronnieMax = getMaxPriceDrink(ronnieStats.drinks);
        const kevinSugarStats = getPreferenceStats(kevinStats.drinks, 'sugar');
        const ronnieSugarStats = getPreferenceStats(ronnieStats.drinks, 'sugar');
        const maxVal = Math.max(1, ...monthlyData.map(d => Math.max(d.Kevin, d.Ronnie)));

        return (
          <div className="animate-in fade-in slide-in-from-bottom-4 duration-500 space-y-6">
            <div
              className="bg-white rounded-3xl shadow-sm p-4 md:p-6 flex flex-col md:flex-row items-center justify-between border-2 border-white/50 gap-4">
              <div className="flex items-center gap-3 md:gap-4 w-full md:w-auto">
                <div className="p-3 md:p-4 bg-[#FFF3E0] rounded-2xl text-[#FB8C00]">
                  <Icons.BarChart3 className="w-5 h-5 md:w-6 md:h-6" />
                </div>
                <div>
                  <h2 className="text-lg md:text-2xl font-black text-[#5A3E2B]">詳細數據分析</h2>
                  <p className="text-xs md:text-sm text-[#A1887F] mt-0.5 md:mt-1 font-medium">Kevin 與 Ronnie 的飲料大數據
                  </p>
                </div>
              </div>
              <button onClick={exportToCSV}
                className="w-full md:w-auto justify-center px-4 py-3 md:py-2 bg-[#FFEFD5] text-[#E65100] rounded-xl font-bold flex items-center gap-2 hover:bg-[#FFE0B2] transition-colors shadow-sm">
                <Icons.Download size={18} /> <span className="inline">匯出 CSV</span>
              </button>
            </div>
            <div className="bg-white rounded-[2rem] shadow-sm p-8 border-2 border-white/50">
              <h3 className="text-xl font-bold text-[#5A3E2B] mb-6 flex items-center gap-2">
                <Icons.TrendingUp size={18} className="text-[#FFCB7D]" /> 月度杯數趨勢
              </h3>
              <div className="h-48 flex items-end justify-between gap-2">
                {monthlyData.map((data) => (
                  <div key={data.month} className="flex-1 flex flex-col justify-end items-center gap-2 group h-full">
                    <div className="w-full flex gap-1 items-end justify-center h-full relative px-0.5">
                      <div
                        className="opacity-0 group-hover:opacity-100 absolute -top-12 bg-[#5A3E2B] text-[#FFFBF0] text-xs py-1 px-3 rounded-full z-10 whitespace-nowrap pointer-events-none transition-opacity font-bold">
                        {data.month}月: K {data.Kevin} / R {data.Ronnie}</div>
                      <div style={{ height: `${(data.Kevin / maxVal) * 100}%` }} className={`w-1/2 max-w-[16px]
                        bg-[#AEE1FA] rounded-t-md transition-all duration-500 relative group-hover:opacity-80
                        ${data.Kevin === 0 ? 'min-h-[2px] bg-opacity-20' : 'min-h-[4px]'}`}></div>
                      <div style={{ height: `${(data.Ronnie / maxVal) * 100}%` }} className={`w-1/2 max-w-[16px]
                        bg-[#FFC4D6] rounded-t-md transition-all duration-500 relative group-hover:opacity-80
                        ${data.Ronnie === 0 ? 'min-h-[2px] bg-opacity-20' : 'min-h-[4px]'}`}></div>
                    </div>
                    <span className="text-[10px] text-[#A1887F] font-bold whitespace-nowrap">{data.month}月</span>
                  </div>
                ))}
              </div>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              {[{ user: 'Kevin', stats: kevinStats, bg: 'bg-[#E0F4FF]', text: 'text-[#4A90B2]' }, {
                user: 'Ronnie',
                stats: ronnieStats, bg: 'bg-[#FFF0F5]', text: 'text-[#D97395]'
              }].map(({ user, stats, bg, text }) => {
                const topShops = getTopShops(stats.drinks);
                return (
                  <div key={user} className={`rounded-[2rem] p-6 border-4 border-white ${bg}`}>
                    <h3 className={`font-bold text-lg mb-4 flex items-center gap-2 ${text}`}>
                      <Icons.Store size={18} /> {user} 的最愛店家
                    </h3>
                    <div className="space-y-3">
                      {topShops.map(([shop, count], idx) => (
                        <div key={shop} className="flex items-center justify-between bg-white/60 p-3 rounded-2xl">
                          <div className="flex items-center gap-3">
                            <span className={`w-7 h-7 rounded-full flex items-center justify-center text-xs font-black
                          ${idx === 0 ? 'bg-[#FFCB7D] text-[#5A3E2B]' : 'bg-white text-[#A1887F]'}`}>{idx + 1}</span>
                            <span className="font-bold text-[#5A3E2B]">{shop}</span>
                          </div>
                          <span className="text-sm font-bold text-[#A1887F]">{count} 杯</span>
                        </div>
                      ))}
                    </div>
                  </div>
                );
              })}
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div className="bg-white rounded-[2rem] shadow-sm p-6 border-2 border-white/50">
                <h3 className="text-lg font-bold text-[#5A3E2B] mb-4 flex items-center gap-2">
                  <Icons.PieChart size={18} className="text-[#FFCB7D]" /> 甜度分佈比較
                </h3>
                <div className="space-y-3">
                  <div
                    className="flex justify-between items-center text-xs font-black px-2 pb-2 border-b border-[#F5F5F5] mb-2">
                    <span className="text-[#4A90B2] w-1/3 text-right">Kevin</span>
                    <span className="text-[#A1887F] w-1/3 text-center">甜度</span>
                    <span className="text-[#D97395] w-1/3 text-left">Ronnie</span>
                  </div>
                  {SUGAR_LEVELS.map((level) => {
                    const kData = kevinSugarStats.find(s => s.label === level) || { count: 0, percent: 0 };
                    const rData = ronnieSugarStats.find(s => s.label === level) || { count: 0, percent: 0 };
                    if (kData.count === 0 && rData.count === 0) return null;
                    return (
                      <div key={level} className="grid grid-cols-[1fr_auto_1fr] gap-3 items-center group">
                        <div className="flex items-center justify-end gap-2 w-full">
                          <span className={`text-[10px] font-bold text-[#4A90B2] opacity-0 group-hover:opacity-100
                          transition-opacity ${kData.count === 0 ? 'hidden' : ''}`}>{kData.percent}%</span>
                          <div
                            className="h-3 bg-[#E0F4FF] rounded-l-full rounded-r-sm flex justify-end w-full overflow-hidden bg-opacity-30 relative">
                            <div
                              className="h-full bg-[#AEE1FA] rounded-l-full rounded-r-sm transition-all duration-700 ease-out"
                              style={{ width: `${kData.percent}%` }}></div>
                          </div>
                        </div>
                        <span className="text-xs font-bold text-[#8D6E63] w-12 text-center shrink-0">{level}</span>
                        <div className="flex items-center justify-start gap-2 w-full">
                          <div
                            className="h-3 bg-[#FFF0F5] rounded-r-full rounded-l-sm w-full overflow-hidden bg-opacity-30 relative">
                            <div
                              className="h-full bg-[#FFC4D6] rounded-r-full rounded-l-sm transition-all duration-700 ease-out"
                              style={{ width: `${rData.percent}%` }}></div>
                          </div>
                          <span className={`text-[10px] font-bold text-[#D97395] opacity-0 group-hover:opacity-100
                          transition-opacity ${rData.count === 0 ? 'hidden' : ''}`}>{rData.percent}%</span>
                        </div>
                      </div>
                    )
                  })}
                </div>
              </div>
              <div className="bg-white rounded-[2rem] shadow-sm p-6 border-2 border-white/50">
                <h3 className="text-lg font-bold text-[#5A3E2B] mb-4 flex items-center gap-2">
                  <Icons.DollarSign size={18} className="text-[#FFCB7D]" /> 最奢侈的一杯
                </h3>
                <div className="space-y-4">
                  {[{ u: 'Kevin', d: kevinMax, c: 'bg-[#E0F4FF] text-[#4A90B2]' }, {
                    u: 'Ronnie', d: ronnieMax, c:
                      'bg-[#FFF0F5] text-[#D97395]'
                  }].map(({ u, d, c }) => (
                    <div key={u} className={`flex items-center gap-4 p-4 rounded-2xl ${c}`}>
                      <div className="font-black text-sm">{u}</div>
                      <div className="flex-1 min-w-0">
                        {d ? <>
                          <div className="font-bold truncate">{d.shopName}</div>
                          <div className="text-xs opacity-80 truncate">{d.itemName}</div>
                        </> : <span className="text-xs opacity-60">無紀錄</span>}
                      </div>
                      {d && <div className="text-lg font-black">${d.price}</div>}
                    </div>
                  ))}
                </div>
              </div>
            </div>
          </div>
        );
      };

      const AchievementsView = () => {
        const openHistory = (ach, user) => {
          setSelectedAchievement({ ...ach, user });
        };

        return (
          <div className="animate-in fade-in slide-in-from-bottom-4 duration-500 space-y-6">
            <div className="bg-white rounded-3xl shadow-sm p-6 flex items-center gap-4 border-2 border-white/50">
              <div className="p-3 md:p-4 bg-[#FFF3E0] rounded-2xl text-[#FB8C00]">
                <Icons.Medal size={20} />
              </div>
              <div>
                <h2 className="text-lg md:text-2xl font-black text-[#5A3E2B]">成就貼紙簿</h2>
                <p className="text-sm text-[#A1887F] mt-1 font-medium">收集滿滿的榮譽（與熱量）！</p>
              </div>
            </div>

            <div className="space-y-8">
              {[{ user: 'Kevin', stats: kevinStats, headerBg: 'bg-[#E0F4FF]', borderColor: 'border-[#AEE1FA]' }, {
                user: 'Ronnie', stats: ronnieStats, headerBg: 'bg-[#FFF0F5]', borderColor: 'border-[#FFC4D6]'
              }].map(({
                user, stats, headerBg, borderColor }) => (
                <div key={user} className={`bg-white rounded-[2.5rem] shadow-md border-4 ${borderColor}
                  overflow-hidden`}>
                  <div className={`${headerBg} p-6 border-b-2 border-white flex items-center gap-3`}>
                    <div className="bg-white p-2 rounded-full shadow-sm">
                      <Icons.User size={18} className={user === 'Kevin' ? 'text-[#4A90B2]' : 'text-[#D97395]'} />
                    </div>
                    <h4 className="font-black text-xl text-[#5A3E2B]">{user} 的收藏</h4>
                  </div>

                  {/* SCRAPBOOK GRID */}
                  <div className="p-6">
                    <div className="grid grid-cols-2 md:grid-cols-3 gap-6 md:gap-8">
                      {stats.achievements.map((ach) => {
                        const count = ach.items.length;
                        const latestItem = count > 0 ? ach.items[count - 1] : null;
                        const isLocked = count === 0;
                        const seed = ach.id.charCodeAt(0) + ach.id.charCodeAt(ach.id.length - 1);
                        const rotation = isLocked ? 0 : (seed % 10) - 5;
                        const tapeRotation = (seed % 6) - 3;

                        // Find latest photo for thumbnail
                        // DEBUG: Check data availability
                        // console.log('All Users Memories:', memoryPhotos);
                        const relevantMemories = memoryPhotos.filter(m => {
                          // Loose comparison for user to handle potential whitespace trimming differences
                          const userMatch = (m.user || '').trim() === user;
                          const titleMatch = m.title === ach.title;
                          return userMatch && titleMatch;
                        });
                        console.log(`Checking ${user} - ${ach.title}: Found ${relevantMemories.length} memories`, relevantMemories);

                        const latestMemory = relevantMemories.length > 0 ? relevantMemories[relevantMemories.length - 1] :
                          null;

                        const tapeColor = ach.tapeColor || 'bg-red-400/30';

                        return (
                          <div key={ach.id} className="relative group flex justify-center py-2 h-full">
                            {/* NEW: Conditional Rendering Logic */}
                            {latestMemory ? (
                              /* BRANCH A: HAS PHOTO -> PolaroidCard (brings its own tape) */
                              <div onClick={() => openHistory(ach, user)} className="w-full flex justify-center cursor-pointer">
                                <PolaroidCard
                                  imageSrc={latestMemory.photoUrl}
                                  date={latestItem.date}
                                  rotation={`rotate-[${rotation}deg]`}
                                  washiTapeColor={tapeColor}
                                  className="w-full max-w-[180px] shadow-lg hover:shadow-xl transition-shadow"
                                  style={{ transform: `rotate(${rotation}deg)` }}
                                />
                              </div>
                            ) : (
                              /* BRANCH B: NO PHOTO -> Sticker (brings its own tape) */
                              <div onClick={() => openHistory(ach, user)}
                                className={`
                              relative w-full h-fit max-w-[180px] bg-white p-2 pb-5 transform transition-all duration-300
                              cursor-pointer
                              ${isLocked ? 'shadow-md' : 'sticker-hover shadow-[0_8px_20px_rgba(0,0,0,0.15)]'}
                              `}
                                style={{ transform: `rotate(${rotation}deg)` }}
                              >
                                {/* WASHI TAPE (Only for Sticker) */}
                                <div className={`absolute -top-3 left-1/2 -translate-x-1/2 w-16 h-4 ${tapeColor} backdrop-blur-[1px] shadow-sm z-20`} style={{
                                  transform:
                                    `translateX(-50%) rotate(${tapeRotation}deg)`,
                                  clipPath: 'polygon(2% 0%, 98% 2%, 100% 100%, 0% 98%)',
                                  maskImage: 'repeating-linear-gradient(-45deg,transparent,transparent 2px,black 3px,black 6px)'
                                }}></div>

                                {/* PHOTO AREA */}
                                <div className={` w-full aspect-square mb-2 overflow-hidden relative flex items-center
                                justify-center ${isLocked
                                    ? 'bg-gradient-to-br from-zinc-700 to-black polaroid-texture shadow-inner border border-zinc-600'
                                    : `${ach.bg} border border-black/5`} `}>
                                  {isLocked ? (
                                    <>
                                      <div
                                        className="absolute inset-0 bg-gradient-to-tr from-transparent via-white/5 to-transparent pointer-events-none">
                                      </div>
                                      <div className="text-white/20 filter blur-[1px] scale-110">{ach.icon}</div>
                                      <Icons.Lock size={16} className="absolute bottom-2 right-2 text-white/30" />
                                    </>
                                  ) : (
                                    <>
                                      <div className="scale-125 drop-shadow-sm">{ach.icon}</div>
                                      {count > 1 && (<div
                                        className="absolute top-0 right-0 bg-[#FF7043] text-white text-[10px] font-black px-1.5 py-0.5 rounded-bl-lg shadow-sm z-20">
                                        x{count}</div>)}
                                    </>
                                  )}
                                </div>

                                {/* CAPTION AREA */}
                                <div className="text-center h-full flex flex-col justify-end">
                                  {isLocked ? (
                                    <div className="font-bold text-gray-400 text-xs tracking-wide">點擊查看線索</div>
                                  ) : (
                                    <>
                                      <div
                                        className="font-bold text-[#5A3E2B] text-xs leading-tight line-clamp-2 mb-0.5 font-handwriting text-sm">
                                        {latestItem.shopName || ach.title}</div>
                                      <div className="text-[10px] text-[#8D6E63] font-medium opacity-80">{latestItem.date}</div>
                                    </>
                                  )}
                                </div>

                              </div>
                            )}
                          </div>

                        );
                      })}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        );
      };



      return (
        <div
          className="min-h-screen bg-[#FFFBF0] text-[#5A3E2B] font-sans pb-24 md:pb-10 relative overflow-x-hidden selection:bg-[#FFE0B2] selection:text-[#5A3E2B]">
          {/* ... (rest of the render) ... */}
          {/* Since we can't easily do Portals in this single-file setup without more complexity,
              we will keep the Modal inside BobaTracker but at the very end of the outer div
              so it overlays everything.
              */}

          <div
            className="fixed -top-20 -left-20 w-80 h-80 bg-[#FFEFD5] rounded-full blur-3xl opacity-60 pointer-events-none">
          </div>
          <div
            className="fixed top-40 -right-20 w-96 h-96 bg-[#FFE4E1] rounded-full blur-3xl opacity-50 pointer-events-none">
          </div>

          <header
            className="sticky top-0 z-40 backdrop-blur-md bg-white/70 border-b border-white/50 shadow-sm transition-all duration-300">
            {/* ... Header Content ... */}
            <div className="max-w-4xl mx-auto px-6 py-4">
              {statusMsg && (
                <div className={`text-center py-2 px-4 mb-4 rounded-lg text-sm font-bold shadow-sm animate-pulse
                    ${statusMsg.includes('失敗') || statusMsg.includes('錯誤') || statusMsg.includes('Error')
                    ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-700'}`}>
                  {statusMsg}
                </div>
              )}
              {/* FLEX FIX: Stack vertically on mobile */}
              <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                <div className="flex items-center gap-3 w-full md:w-auto">
                  <div
                    className="bg-gradient-to-tr from-[#FFCB7D] to-[#FFDCA9] p-2.5 rounded-2xl text-[#5A3E2B] shadow-inner transform hover:rotate-12 transition-transform">
                    <BobaIcon size={24} />
                  </div>
                  <div className="flex-1 md:flex-none">
                    <h1 className="text-2xl font-black tracking-wider text-[#5A3E2B]">我超愛喝手搖</h1>
                    <p className="text-[#8D6E63] text-xs font-bold mt-0.5 flex items-center gap-2">Kevin <span
                      className="text-[#FFCB7D]">⚡️</span> Ronnie {isLoading ? <span
                        className="animate-pulse bg-gray-200 text-gray-500 px-1 rounded text-[10px]">讀取中...</span> :
                        <span className="text-green-500 flex items-center gap-0.5 text-[10px]">
                          <Icons.Wifi size={10} /> 已連線
                        </span>}
                    </p>
                  </div>
                </div>
                {/* NAV FIX: Hide on mobile, show on desktop */}
                <nav className="hidden md:flex bg-[#F5F0EB] rounded-2xl p-1.5 shadow-inner">
                  {[{ id: 'calendar', label: '日曆', icon: Icons.Calendar }, {
                    id: 'stats', label: '分析', icon:
                      Icons.BarChart3
                  }, { id: 'achievements', label: '成就', icon: Icons.Medal }].map(item => (
                    <button key={item.id} onClick={() => setCurrentView(item.id)} className={`px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2 transition-all ${currentView === item.id ? 'bg-white text-[#5A3E2B] shadow-md scale-105' : 'text-[#A1887F] hover:bg-white/50'}`}>
                      <item.icon size={16} /> {item.label}
                    </button>
                  ))}
                </nav>
              </div>
              <div className="mt-4 grid grid-cols-2 gap-4">
                {USERS.map((u, i) => {
                  const stats = i === 0 ? kevinStats : ronnieStats;
                  const isWin = stats.cups > (i === 0 ? ronnieStats.cups : kevinStats.cups);
                  return (
                    <div key={u.name} className={`relative overflow-hidden rounded-2xl p-3 flex items-center
                      justify-between border-2 border-white ${u.lightColor}`}>
                      <div className="flex items-center gap-3 z-10">
                        <div className={`p-2 rounded-xl ${u.color} text-white`}>
                          <Icons.User size={18} />
                        </div>
                        <div>
                          <div className={`text-xs font-bold ${u.textColor}`}>{u.name}</div>
                          <div className="text-lg font-black text-[#5A3E2B]">{stats.cups} <span
                            className="text-xs font-normal text-[#8D6E63]">杯</span></div>
                        </div>
                      </div>
                      <div className="text-right z-10">
                        <div className="text-xs font-bold text-[#8D6E63] opacity-70">花費</div>
                        <div className="font-bold text-[#5A3E2B]">${stats.cost}</div>
                      </div>
                      {isWin &&
                        <Icons.Trophy className="absolute -right-2 -bottom-2 text-yellow-400 opacity-20 rotate-12"
                          size={64} />}
                    </div>
                  );
                })}
              </div>
            </div>
          </header >

          <main className="max-w-4xl mx-auto px-4 mt-6 relative z-10">
            {currentView === 'calendar' && (
              <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
                <div className="bg-white rounded-[2rem] p-2 shadow-sm border-2 border-white">
                  <div className="flex justify-between items-center p-4">
                    <button onClick={handlePrevMonth}
                      className="p-3 hover:bg-[#FFF8E1] rounded-2xl text-[#8D6E63] transition-colors">
                      <Icons.ChevronLeft size={20} />
                    </button>
                    <h2
                      className="text-xl font-black text-[#5A3E2B] flex items-center gap-2 bg-[#FFF8E1] px-6 py-2 rounded-2xl">
                      <Icons.Calendar size={18} className="text-[#F4A261]" /> {currentDate.getFullYear()} 年
                      {currentDate.getMonth() + 1} 月
                    </h2>
                    <button onClick={handleNextMonth}
                      className="p-3 hover:bg-[#FFF8E1] rounded-2xl text-[#8D6E63] transition-colors">
                      <Icons.ChevronRight size={20} />
                    </button>
                  </div>
                  <div className="grid grid-cols-7 mb-2">
                    {['日', '一', '二', '三', '四', '五', '六'].map(d => (<div key={d}
                      className="py-2 text-center text-xs font-black text-[#BCAAA4]">{d}</div>))}
                  </div>
                  <div className="grid grid-cols-7 gap-1 px-1 pb-1">
                    {renderCalendarDays()}
                  </div>
                </div>
                <div className="text-center text-[#A1887F] text-xs font-bold flex justify-center gap-6 mt-6">
                  <div className="flex items-center gap-2">
                    <div className="w-3 h-3 rounded-full bg-[#AEE1FA] border border-white shadow-sm"></div> Kevin 喝的
                  </div>
                  <div className="flex items-center gap-2">
                    <div className="w-3 h-3 rounded-full bg-[#FFC4D6] border border-white shadow-sm"></div> Ronnie 喝的
                  </div>
                </div>
              </div>
            )}
            {currentView === 'stats' &&
              <StatsView />}
            {currentView === 'achievements' &&
              <AchievementsView />}
          </main>

          {/* BOTTOM NAV FIX: Show on mobile only */}
          <div
            className="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-[#E0E0E0] shadow-[0_-4px_20px_rgba(0,0,0,0.05)] z-40 px-6 pb-safe pt-2">
            <nav className="flex justify-center items-center gap-4">
              {[{ id: 'calendar', label: '日曆', icon: Icons.Calendar }, {
                id: 'stats', label: '分析', icon:
                  Icons.BarChart3
              }, { id: 'achievements', label: '成就', icon: Icons.Medal }].map(item => (
                <button key={item.id} onClick={() => setCurrentView(item.id)} className={`flex flex-col items-center
                    gap-1 p-2 rounded-xl transition-all w-20 ${currentView === item.id ? 'text-[#5A3E2B] -translate-y-2'
                    : 'text-[#BCAAA4]'}`}>
                  <div className={`p-2 rounded-full transition-all ${currentView === item.id ? 'bg-[#FFCB7D] shadow-md'
                    : 'bg-transparent'}`}>
                    <item.icon size={20} className={currentView === item.id ? 'text-[#5A3E2B]' : 'text-[#BCAAA4]'} />
                  </div>
                  <span className={`text-[10px] font-bold ${currentView === item.id ? 'opacity-100' : 'opacity-70'
                    }`}>{item.label}</span>
                </button>
              ))}
            </nav>
            {/* Safe Area padding div */}
            <div className="h-4 w-full"></div>
          </div>

          <button onClick={() => setIsRandomizerOpen(true)} className="fixed bottom-24 md:bottom-8 right-4 md:right-8
                bg-[#5A3E2B] text-[#FFCB7D] p-4 md:p-5 rounded-[2rem] shadow-[0_8px_30px_rgb(90,62,43,0.3)]
                hover:scale-110 active:scale-95 transition-all z-30 group border-4 border-[#FFFBF0]">
            <Icons.Dices size={24} className="group-hover:rotate-180 transition-transform duration-500" />
          </button>
          {
            isRandomizerOpen &&
            <RandomizerModal />
          }
          {lightBoxPhoto && <MemoryLightbox photo={lightBoxPhoto} onClose={() => setLightBoxPhoto(null)} />}

          {
            unlockedQueue.length > 0 && (
              <ErrorBoundary onReset={() => setUnlockedQueue(prev => prev.slice(1))}>
                <CelebrationCameraModal achievement={unlockedQueue[0]} user={selectedUser} onClose={() =>
                  setUnlockedQueue(prev => prev.slice(1))}
                  onSaveMemory={async (url) => {
                    // Send to GAS
                    const achievement = unlockedQueue[0];
                    // Identify the triggering drink (usually the last one added)
                    const lastItem = achievement.items && achievement.items.length > 0
                      ? achievement.items[achievement.items.length - 1]
                      : null;
                    const sourceDrinkId = lastItem ? lastItem.timestamp : null;

                    await fetch(GOOGLE_SCRIPT_URL, {
                      method: 'POST',
                      headers: { 'Content-Type': 'text/plain' },
                      body: JSON.stringify({
                        action: 'UNLOCK_ACHIEVEMENT',
                        user: selectedUser,
                        achievementTitle: achievement.title,
                        photoUrl: url,
                        sourceDrinkId: sourceDrinkId // New Foreign Key
                      })
                    });
                    // After save, close modal (the modal itself handles the timeout delay for UX)
                  }}
                />
              </ErrorBoundary>
            )
          }

          {
            selectedAchievement && (
              <div
                className="fixed inset-0 bg-[#5A3E2B]/40 z-[100] flex items-center justify-center p-4 backdrop-blur-sm"
                onClick={() => setSelectedAchievement(null)}>
                <div className={`bg-[#FFFBF0] rounded-[2.5rem] shadow-2xl w-full max-w-md p-6 text-center relative
                    border-4 border-white animate-in zoom-in duration-200 flex flex-col max-h-[85vh]`} onClick={e =>
                    e.stopPropagation()}>
                  <button onClick={() => setSelectedAchievement(null)} className="absolute top-4 right-4 text-[#A1887F]
                      hover:text-[#5A3E2B] bg-white rounded-full p-2 hover:bg-[#FFE0B2] transition-colors z-10">
                    <Icons.X size={20} />
                  </button>

                  {/* Header & Icon */}
                  <div className="text-center mb-6">
                    {selectedAchievement.items.length === 0 ? (
                      <>
                        <div
                          className="mx-auto w-20 h-20 rounded-full flex items-center justify-center mb-3 shadow-inner bg-zinc-800 border-4 border-white relative overflow-hidden">
                          <div className="absolute inset-0 polaroid-texture opacity-50"></div>
                          <div className="scale-150 filter grayscale opacity-20 text-white">{selectedAchievement.icon}
                          </div>
                        </div>
                        <h3 className="text-2xl font-black text-[#616161]">未解鎖...</h3>
                        <p className="text-xs text-[#9E9E9E] font-medium mt-1 font-serif italic">Achievement Locked.</p>
                      </>
                    ) : (
                      <>
                        <div className={`mx-auto w-20 h-20 rounded-full flex items-center justify-center mb-3
                          shadow-inner ${selectedAchievement.bg}`}>
                          <div className="scale-150">{selectedAchievement.icon}</div>
                        </div>
                        <h3 className="text-2xl font-black text-[#5A3E2B]">{selectedAchievement.title}</h3>
                        <p className="text-xs text-[#8D6E63] font-medium mt-1">累計獲得 {selectedAchievement.items.length} 次
                        </p>
                      </>
                    )}
                  </div>

                  {/* SCROLLABLE CONTENT AREA */}
                  <div className="overflow-y-auto flex-1 -mx-2 px-2 pb-4 space-y-6 scrollbar-hide">


                    {/* MEMORY GRID SECTION */}
                    <div className="flex-1 overflow-y-auto px-4 pb-8 scrollbar-hide">
                      {selectedAchievement.items.length === 0 ? (
                        <div className="p-8 flex flex-col items-center justify-center h-full text-center">
                          <Icons.Lock size={48} className="text-[#E0E0E0] mb-6" />
                          <p className="text-[#8D6E63] text-lg font-serif italic mb-8 mx-auto max-w-xs leading-relaxed">
                            "{selectedAchievement.riddle}"
                          </p>

                          <div className="w-full max-w-[200px]">
                            <div className="flex justify-between text-xs font-bold text-[#BDBDBD] mb-2">
                              <span>解鎖進度</span>
                              <span>{selectedAchievement.progress}/{selectedAchievement.target}</span>
                            </div>
                            <div className="w-full bg-[#EFEBE9] h-2 rounded-full overflow-hidden">
                              <div className="bg-[#BCAAA4] h-full rounded-full transition-all duration-1000" style={{
                                width: `${Math.min((selectedAchievement.progress / selectedAchievement.target) * 100, 100)}%`
                              }}></div>
                            </div>
                          </div>
                        </div>
                      ) : (
                        /* GRID CONTAINER */
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 auto-rows-max">
                          {selectedAchievement.items.slice().reverse().map((item, i) => {
                            // Find linked photo
                            const linkedPhoto = memoryPhotos.find(p => p.sourceDrinkId === item.timestamp && p.user === selectedAchievement.user);
                            const seed = item.timestamp % 100;
                            const rotation = (seed % 6) - 3;

                            if (linkedPhoto) {
                              /* TYPE A: MINI POLAROID (Has Photo) */
                              return (
                                <div key={i}
                                  onClick={() => setLightBoxPhoto({ ...linkedPhoto, ...item, tapeColor: selectedAchievement.tapeColor })}
                                  className={`
                                    relative bg-white p-2 pb-8 shadow-md rounded-sm cursor-pointer 
                                    transform transition-all duration-300 hover:scale-105 hover:z-10 hover:shadow-xl
                                  `}
                                  style={{ transform: `rotate(${rotation}deg)` }}
                                >
                                  {/* Tape */}
                                  <div className={`absolute -top-2 left-1/2 -translate-x-1/2 w-12 h-3 ${selectedAchievement.tapeColor || 'bg-amber-200'} opacity-90 shadow-sm z-20`}
                                    style={{ transform: 'translateX(-50%) rotate(-2deg)' }}></div>

                                  {/* Photo */}
                                  <div className="w-full aspect-square bg-gray-100 overflow-hidden mb-2">
                                    <img src={linkedPhoto.photoUrl} className="w-full h-full object-cover" loading="lazy" />
                                  </div>

                                  {/* Date Caption */}
                                  <div className="absolute bottom-2 left-0 w-full text-center">
                                    <div className="text-[10px] text-gray-400 font-mono tracking-tighter transform scale-90">{item.date}</div>
                                  </div>
                                </div>
                              );
                            } else {
                              /* TYPE B: RECEIPT STUB (No Photo) */
                              return (
                                <div key={i} className="relative group bg-[#FAFAFA] text-[#5D4037] p-3 shadow-sm flex flex-col justify-between min-h-[140px] font-mono text-xs border-t-2 border-dashed border-gray-300/50">
                                  {/* Zigzag decoration could be done with CSS background patterns or clip-path if desired, simplified here as dashed border */}

                                  <div className="flex flex-col gap-1 z-10">
                                    <div className="border-b border-dashed border-gray-300 pb-1 mb-1 font-bold text-gray-400 opacity-60 text-[10px] tracking-widest uppercase">
                                      RECEIPT
                                    </div>
                                    <div className="font-bold text-sm tracking-tight leading-tight line-clamp-2">{item.shopName}</div>
                                    <div className="text-[10px] opacity-80 leading-tight line-clamp-2">{item.itemName}</div>
                                  </div>

                                  <div className="mt-2 pt-2 border-t border-dashed border-gray-300 z-10">
                                    <div className="flex justify-between items-end">
                                      <div className="text-[10px] text-gray-400">{item.date.replace(/-/g, '.')}</div>
                                      <div className="text-sm font-black text-gray-800">${item.price}</div>
                                    </div>
                                  </div>

                                  {/* Subtle texture overlay */}
                                  <div className="absolute inset-0 bg-white opacity-50 pointer-events-none mix-blend-overlay"></div>
                                </div>
                              );
                            }
                          })}
                        </div>
                      )}
                    </div>
                  </div>

                </div>
              </div>
            )
          }

          {
            isModalOpen && (
              <div
                className="fixed inset-0 bg-[#5A3E2B]/30 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                <div
                  className="bg-[#FFFBF0] rounded-[2.5rem] shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto animate-in fade-in zoom-in duration-200 border-4 border-white">
                  <div
                    className="bg-white/50 p-6 flex justify-between items-center sticky top-0 z-30 backdrop-blur-md">
                    <h3 className="text-xl font-black text-[#5A3E2B] flex items-center gap-2">
                      <Icons.Coffee size={20} className="text-[#F4A261]" /> {selectedDate}
                    </h3>
                    <button onClick={() => setIsModalOpen(false)} className="text-[#A1887F] hover:text-[#5A3E2B]
                        bg-white rounded-full p-3 hover:bg-[#FFE0B2] transition-colors">
                      <Icons.X size={20} />
                    </button>
                  </div>
                  <div className="p-6 space-y-6">
                    <div className="space-y-4">
                      {(!records[selectedDate] || records[selectedDate].length === 0) ? (
                        <div
                          className="text-center py-10 bg-white rounded-3xl border-2 border-dashed border-[#E0E0E0] text-[#BCAAA4] font-medium">
                          今天還沒喝飲料喔！🥤</div>
                      ) : (
                        records[selectedDate].map((record) => {
                          const isKevin = (record.user || '').trim() === 'Kevin';
                          let timeString = '??:??'; try {
                            const tsString = String(record.timestamp); const validTs =
                              Number(tsString.length > 13 ? tsString.slice(0, 13) : tsString); timeString = new
                                Date(validTs).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                          } catch (e) { }
                          return (
                            <div key={record.id} className={`bg-white border-4 ${isKevin ? 'border-[#E0F4FF]'
                              : 'border-[#FFF0F5]'} shadow-sm p-4 rounded-3xl flex justify-between items-center`}>
                              <div className="flex-1 min-w-0 mr-2">
                                <div className="flex items-center gap-2 mb-1.5 flex-wrap">
                                  <span className={`text-[10px] font-black px-2.5 py-1 rounded-full ${isKevin
                                    ? 'bg-[#AEE1FA] text-[#4A90B2]' : 'bg-[#FFC4D6] text-[#D97395]'}`}>{record.user}</span>
                                  <span className="font-bold text-[#5A3E2B] text-lg truncate">{record.shopName}</span>
                                  <span className="font-black text-[#F4A261] text-lg">${record.price}</span>
                                </div>
                                <div className="text-sm text-[#8D6E63] font-medium flex items-center gap-1 truncate"><span
                                  className="text-xs font-mono text-[#BCAAA4] mr-1 shrink-0">{timeString}</span><span
                                    className="truncate">{record.itemName} <span className="mx-1">·</span>
                                    {record.ice}・{record.sugar}</span></div>
                              </div>
                              <div className="flex items-center gap-2 shrink-0">
                                <button onClick={() => handleEdit(record)} className="text-[#A1887F] bg-[#EFEBE9] p-3
                              rounded-full hover:bg-[#D7CCC8] hover:text-[#5D4037] transition-colors relative z-10"
                                  title="編輯紀錄">
                                  <Icons.Pencil size={18} />
                                </button>
                                <button onClick={() => handleDeleteDrink(record)} className="text-[#D7CCC8] bg-[#EFEBE9] p-3
                              rounded-full hover:bg-[#FFEBEE] hover:text-[#FF8A80] transition-colors relative z-10"
                                  title="刪除紀錄">
                                  <Icons.Trash2 size={18} />
                                </button>
                              </div>
                            </div>
                          );
                        })
                      )}
                    </div>
                    <div className={`bg-white rounded-3xl p-6 shadow-sm border-2 ${editingId
                      ? 'border-[#81C784] bg-[#F1F8E9]' : 'border-[#FFF3E0]'}`}>
                      <div className="flex items-center justify-between mb-4">
                        <div className="flex items-center gap-2">
                          <div className={`p-1.5 rounded-lg ${editingId ? 'bg-[#C8E6C9]' : 'bg-[#FFF3E0]'}`}>
                            {editingId ?
                              <Icons.Pencil size={16} className="text-[#388E3C]" /> :
                              <Icons.Plus size={16} className="text-[#FB8C00]" />}
                          </div>
                          <h4 className={`font-black ${editingId ? 'text-[#388E3C]' : 'text-[#5A3E2B]'}`}>{editingId
                            ? '編輯紀錄' : '新增紀錄'}</h4>
                        </div>
                      </div>
                      <div className="space-y-5">
                        <div className="mb-3"><label
                          className="text-xs font-bold text-[#A1887F] ml-1 mb-1 block">日期時間</label>
                          <CustomDateTimePicker value={recordDateTime} onChange={handleDateTimeChange} />
                        </div>
                        <div className="grid grid-cols-2 gap-3">{USERS.map(user => (<button key={user.name}
                          onClick={() => setSelectedUser(user.name)} className={`py-3 rounded-2xl font-bold text-sm transition-all border-4 flex items-center justify-center gap-2 ${selectedUser === user.name ? `${user.borderColor} ${user.lightColor} ${user.textColor}` : 'border-transparent bg-[#F5F5F5] text-[#BDBDBD]'}`}>
                          <Icons.User size={16} />{user.name}
                        </button>))}</div>
                        <div className="grid grid-cols-2 gap-3">
                          <div className="relative">
                            <label className="text-xs font-bold text-[#A1887F] ml-1 mb-1 block">店名</label>
                            <input type="text" value={shopName} onFocus={() => setIsShopDropdownOpen(true)} onBlur={() => setTimeout(() => setIsShopDropdownOpen(false), 200)} onChange={(e) => setShopName(e.target.value)} className="w-full bg-[#FFF8E1] hover:bg-[#FFECB3] border border-[#FFE0B2] rounded-xl h-12 p-3 font-bold text-[#5A3E2B] focus:outline-none focus:ring-2 focus:ring-[#FFCB7D] focus:border-[#FFCB7D] text-base md:text-sm transition-all" placeholder="輸入店名..." />
                            {isShopDropdownOpen && (<div
                              className="absolute z-50 left-0 right-0 mt-2 bg-white border-2 border-[#FFF3E0] rounded-2xl shadow-xl max-h-48 overflow-y-auto p-2">
                              {filteredShops.map((shop) => (<div key={shop}
                                className="px-3 py-2 text-sm font-bold text-[#5A3E2B] hover:bg-[#FFF8E1] rounded-xl cursor-pointer"
                                onClick={() => { setShopName(shop); setIsShopDropdownOpen(false); }}>{shop}</div>))}
                            </div>)}
                          </div>
                          <div><label className="text-xs font-bold text-[#A1887F] ml-1 mb-1 block">品項</label><input
                            type="text" value={itemName} onChange={(e) => setItemName(e.target.value)} className="w-full bg-[#FFF8E1] hover:bg-[#FFECB3] border border-[#FFE0B2] rounded-xl h-12 p-3 font-bold text-[#5A3E2B] focus:outline-none focus:ring-2 focus:ring-[#FFCB7D] focus:border-[#FFCB7D] text-base md:text-sm transition-all" placeholder="珍珠奶茶..." /></div>
                        </div>
                        <div>
                          <label className="text-xs font-bold text-[#A1887F] ml-1 mb-1 block">冰塊</label>
                          <div className="grid grid-cols-6 gap-1">
                            {ICE_LEVELS.map(level => (
                              <button key={level} onClick={() => setIce(level)} className={`py-2 text-[10px] font-bold rounded-xl transition-all ${ice === level ? 'bg-[#B3E5FC] text-[#0277BD]' : 'bg-[#FAFAFA] text-[#BDBDBD] hover:bg-[#E1F5FE]'}`}>
                                {level}
                              </button>
                            ))}
                          </div>
                        </div>
                        <div>
                          <label className="text-xs font-bold text-[#A1887F] ml-1 mb-1 block">甜度</label>
                          <div className="grid grid-cols-6 gap-1">
                            {SUGAR_LEVELS.map(level => (
                              <button key={level} onClick={() => setSugar(level)} className={`py-2 text-[10px] font-bold rounded-xl transition-all ${sugar === level ? 'bg-[#FFCCBC] text-[#D84315]' : 'bg-[#FAFAFA] text-[#BDBDBD] hover:bg-[#FBE9E7]'}`}>
                                {level}
                              </button>
                            ))}
                          </div>
                        </div>
                        <div className="flex gap-3 items-end">
                          <div className="flex-1">
                            <label className="text-xs font-bold text-[#A1887F] ml-1 mb-1 block">價格</label>
                            <div className="relative w-full">
                              <Icons.DollarSign size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-[#D7CCC8]" />
                              <input type="number" value={price} onChange={(e) => setPrice(e.target.value)} className="w-full bg-[#FFF8E1] hover:bg-[#FFECB3] border border-[#FFE0B2] rounded-xl h-12 py-3 pl-10 font-bold text-[#5A3E2B] focus:outline-none focus:ring-2 focus:ring-[#FFCB7D] focus:border-[#FFCB7D] text-base md:text-sm transition-all" placeholder="0" />
                            </div>
                          </div>
                          {editingId && (
                            <button onClick={handleCancelEdit} className="px-4 py-3 rounded-2xl font-bold text-sm bg-gray-200 text-gray-500 hover:bg-gray-300 transition-colors flex items-center justify-center gap-1 shadow-sm h-12">
                              <Icons.Ban size={18} /><span className="hidden sm:inline">取消</span>
                            </button>
                          )}
                          <button onClick={handleAddDrink} disabled={(isDailyLimitReached && !editingId) || isSending} className={`flex-[2] h-12 rounded-2xl font-black text-white shadow-md hover:scale-105 active:scale-95 transition-all flex justify-center items-center gap-2 ${(isDailyLimitReached && !editingId) ? 'bg-gray-400 cursor-not-allowed opacity-80' : editingId ? 'bg-[#66BB6A] hover:bg-[#4CAF50]' : (selectedUser === 'Kevin' ? 'bg-[#70C4EE]' : 'bg-[#FF99B6]')} ${isSending ? 'opacity-50 cursor-not-allowed' : ''}`}>
                            {isSending ? <Icons.RefreshCw className="animate-spin" size={18} /> : editingId ? <><Icons.Save size={18} /> 儲存修改</> : (isDailyLimitReached ? <>⚠️ 已達今日上限 (2/2)</> : <><Icons.Plus size={18} /> 新增</>)}
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            )
          }
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<BobaTracker />);
  </script>
</body>

</html>